function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _CodeHighlightProvider = require('./CodeHighlightProvider');

var _CodeHighlightProvider2 = _interopRequireDefault(_CodeHighlightProvider);

var _atom = require('atom');

var _hackCommonLibConstants = require('../../hack-common/lib/constants');

var _config = require('./config');

var _TypeCoverageProvider = require('./TypeCoverageProvider');

var _featureConfig = require('../../feature-config');

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var HACK_GRAMMARS_STRING = _hackCommonLibConstants.HACK_GRAMMARS.join(', ');
var PACKAGE_NAME = 'nuclide-hack';

var subscriptions = null;
var hackDiagnosticsProvider = undefined;
var busySignalProvider = undefined;
var hackTypeCoverageProviderSubscription = null;
var coverageProvider = null;

module.exports = {

  activate: function activate() {
    var _require = require('./hack');

    var getCachedHackLanguageForUri = _require.getCachedHackLanguageForUri;

    var _require2 = require('../../atom-helpers');

    var projects = _require2.projects;

    subscriptions = new _atom.CompositeDisposable();
    subscriptions.add(projects.onDidRemoveProjectPath(function (projectPath) {
      var hackLanguage = getCachedHackLanguageForUri(projectPath);
      if (hackLanguage) {
        hackLanguage.dispose();
      }
      if (hackDiagnosticsProvider) {
        hackDiagnosticsProvider.invalidateProjectPath(projectPath);
      }
    }));
    subscriptions.add((0, _featureConfig.onDidChange)(_config.SHOW_TYPE_COVERAGE_CONFIG_PATH, function (delta) {
      if (delta.newValue) {
        enableCoverageProvider();
      } else {
        disableCoverageProvider();
      }
    }));
    subscriptions.add(atom.commands.add('atom-workspace', 'nuclide-hack:toggle-type-coverage', toggleTypeCoverage));

    if ((0, _config.getShowTypeCoverage)()) {
      enableCoverageProvider();
    }
  },

  /** Provider for autocomplete service. */
  createAutocompleteProvider: function createAutocompleteProvider() {
    var AutocompleteProvider = require('./AutocompleteProvider');
    var autocompleteProvider = new AutocompleteProvider();

    return {
      selector: _hackCommonLibConstants.HACK_GRAMMARS.map(function (grammar) {
        return '.' + grammar;
      }).join(', '),
      inclusionPriority: 1,
      // The context-sensitive hack autocompletions are more relevant than snippets.
      suggestionPriority: 3,
      excludeLowerPriority: false,

      getSuggestions: function getSuggestions(request) {
        return autocompleteProvider.getAutocompleteSuggestions(request);
      }
    };
  },

  getHyperclickProvider: function getHyperclickProvider() {
    var HackHyperclickProvider = require('./HyperclickProvider');
    var hackHyperclickProvider = new HackHyperclickProvider();
    var getSuggestionForWord = hackHyperclickProvider.getSuggestionForWord.bind(hackHyperclickProvider);
    return {
      priority: 20,
      providerName: PACKAGE_NAME,
      getSuggestionForWord: getSuggestionForWord
    };
  },

  /** Provider for code format service. */
  createCodeFormatProvider: function createCodeFormatProvider() {
    var CodeFormatProvider = require('./CodeFormatProvider');
    var codeFormatProvider = new CodeFormatProvider();

    return {
      selector: HACK_GRAMMARS_STRING,
      inclusionPriority: 1,

      formatCode: function formatCode(editor, range) {
        return codeFormatProvider.formatCode(editor, range);
      }
    };
  },

  createFindReferencesProvider: function createFindReferencesProvider() {
    return require('./FindReferencesProvider');
  },

  createTypeHintProvider: function createTypeHintProvider() {
    var TypeHintProvider = require('./TypeHintProvider');
    var typeHintProvider = new TypeHintProvider();

    return {
      selector: HACK_GRAMMARS_STRING,
      inclusionPriority: 1,
      providerName: PACKAGE_NAME,

      typeHint: function typeHint(editor, position) {
        return typeHintProvider.typeHint(editor, position);
      }
    };
  },

  createCodeHighlightProvider: function createCodeHighlightProvider() {
    var codeHighlightProvider = new _CodeHighlightProvider2['default']();

    return {
      selector: HACK_GRAMMARS_STRING,
      inclusionPriority: 1,
      highlight: function highlight(editor, position) {
        return codeHighlightProvider.highlight(editor, position);
      }
    };
  },

  provideDiagnostics: function provideDiagnostics() {
    if (!hackDiagnosticsProvider) {
      var HackDiagnosticsProvider = require('./HackDiagnosticsProvider');
      var busyProvider = provideBusySignal();
      hackDiagnosticsProvider = new HackDiagnosticsProvider(false, busyProvider);
    }
    return hackDiagnosticsProvider;
  },

  deactivate: function deactivate() {
    if (subscriptions) {
      subscriptions.dispose();
      subscriptions = null;
    }
    if (hackDiagnosticsProvider) {
      hackDiagnosticsProvider.dispose();
      hackDiagnosticsProvider = null;
    }
    disableCoverageProvider();
  }
};

function provideBusySignal() {
  if (busySignalProvider == null) {
    var _require3 = require('../../busy-signal-provider-base');

    var BusySignalProviderBase = _require3.BusySignalProviderBase;

    busySignalProvider = new BusySignalProviderBase();
  }
  return busySignalProvider;
}

function enableCoverageProvider() {
  if (coverageProvider == null) {
    coverageProvider = new _TypeCoverageProvider.TypeCoverageProvider(provideBusySignal());
    (0, _assert2['default'])(hackTypeCoverageProviderSubscription == null);
    hackTypeCoverageProviderSubscription = atom.packages.serviceHub.provide('nuclide-diagnostics-provider', '0.1.0', coverageProvider);
  }
}

function disableCoverageProvider() {
  if (hackTypeCoverageProviderSubscription != null) {
    hackTypeCoverageProviderSubscription.dispose();
    hackTypeCoverageProviderSubscription = null;
  }
  if (coverageProvider != null) {
    coverageProvider.dispose();
    coverageProvider = null;
  }
}

function toggleTypeCoverage() {
  (0, _config.setShowTypeCoverage)(!(0, _config.getShowTypeCoverage)());
}
//# sourceMappingURL=data:application/json;base64,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QyxDQUFDO0FBQ3hELHdDQUFvQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FDckUsOEJBQThCLEVBQUUsT0FBTyxFQUN2QyxnQkFBZ0IsQ0FBQyxDQUFDO0dBQ3JCO0NBQ0Y7O0FBRUQsU0FBUyx1QkFBdUIsR0FBUztBQUN2QyxNQUFJLG9DQUFvQyxJQUFJLElBQUksRUFBRTtBQUNoRCx3Q0FBb0MsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUMvQyx3Q0FBb0MsR0FBRyxJQUFJLENBQUM7R0FDN0M7QUFDRCxNQUFJLGdCQUFnQixJQUFJLElBQUksRUFBRTtBQUM1QixvQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUMzQixvQkFBZ0IsR0FBRyxJQUFJLENBQUM7R0FDekI7Q0FDRjs7QUFFRCxTQUFTLGtCQUFrQixHQUFTO0FBQ2xDLG1DQUFvQixDQUFDLGtDQUFxQixDQUFDLENBQUM7Q0FDN0MiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmltcG9ydCB0eXBlIHtUeXBlSGludH0gZnJvbSAnLi4vLi4vdHlwZS1oaW50LWludGVyZmFjZXMnO1xuaW1wb3J0IHR5cGUge1xuICBCdXN5U2lnbmFsUHJvdmlkZXJCYXNlIGFzIEJ1c3lTaWduYWxQcm92aWRlckJhc2VUeXBlLFxufSBmcm9tICcuLi8uLi9idXN5LXNpZ25hbC1wcm92aWRlci1iYXNlJztcbmltcG9ydCB0eXBlIHtIeXBlcmNsaWNrUHJvdmlkZXJ9IGZyb20gJy4uLy4uL2h5cGVyY2xpY2staW50ZXJmYWNlcyc7XG5cbmltcG9ydCBDb2RlSGlnaGxpZ2h0UHJvdmlkZXIgZnJvbSAnLi9Db2RlSGlnaGxpZ2h0UHJvdmlkZXInO1xuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJztcbmltcG9ydCB7SEFDS19HUkFNTUFSU30gZnJvbSAnLi4vLi4vaGFjay1jb21tb24vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQge1xuICBTSE9XX1RZUEVfQ09WRVJBR0VfQ09ORklHX1BBVEgsXG4gIGdldFNob3dUeXBlQ292ZXJhZ2UsXG4gIHNldFNob3dUeXBlQ292ZXJhZ2UsXG59IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB7VHlwZUNvdmVyYWdlUHJvdmlkZXJ9IGZyb20gJy4vVHlwZUNvdmVyYWdlUHJvdmlkZXInO1xuaW1wb3J0IHtvbkRpZENoYW5nZX0gZnJvbSAnLi4vLi4vZmVhdHVyZS1jb25maWcnO1xuaW1wb3J0IGludmFyaWFudCBmcm9tICdhc3NlcnQnO1xuXG5jb25zdCBIQUNLX0dSQU1NQVJTX1NUUklORyA9IEhBQ0tfR1JBTU1BUlMuam9pbignLCAnKTtcbmNvbnN0IFBBQ0tBR0VfTkFNRSA9ICdudWNsaWRlLWhhY2snO1xuXG5sZXQgc3Vic2NyaXB0aW9uczogP0NvbXBvc2l0ZURpc3Bvc2FibGUgPSBudWxsO1xubGV0IGhhY2tEaWFnbm9zdGljc1Byb3ZpZGVyO1xubGV0IGJ1c3lTaWduYWxQcm92aWRlcjtcbmxldCBoYWNrVHlwZUNvdmVyYWdlUHJvdmlkZXJTdWJzY3JpcHRpb24gPSBudWxsO1xubGV0IGNvdmVyYWdlUHJvdmlkZXIgPSBudWxsO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICBhY3RpdmF0ZSgpIHtcbiAgICBjb25zdCB7Z2V0Q2FjaGVkSGFja0xhbmd1YWdlRm9yVXJpfSA9IHJlcXVpcmUoJy4vaGFjaycpO1xuICAgIGNvbnN0IHtwcm9qZWN0c30gPSByZXF1aXJlKCcuLi8uLi9hdG9tLWhlbHBlcnMnKTtcbiAgICBzdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICBzdWJzY3JpcHRpb25zLmFkZChwcm9qZWN0cy5vbkRpZFJlbW92ZVByb2plY3RQYXRoKHByb2plY3RQYXRoID0+IHtcbiAgICAgIGNvbnN0IGhhY2tMYW5ndWFnZSA9IGdldENhY2hlZEhhY2tMYW5ndWFnZUZvclVyaShwcm9qZWN0UGF0aCk7XG4gICAgICBpZiAoaGFja0xhbmd1YWdlKSB7XG4gICAgICAgIGhhY2tMYW5ndWFnZS5kaXNwb3NlKCk7XG4gICAgICB9XG4gICAgICBpZiAoaGFja0RpYWdub3N0aWNzUHJvdmlkZXIpIHtcbiAgICAgICAgaGFja0RpYWdub3N0aWNzUHJvdmlkZXIuaW52YWxpZGF0ZVByb2plY3RQYXRoKHByb2plY3RQYXRoKTtcbiAgICAgIH1cbiAgICB9KSk7XG4gICAgc3Vic2NyaXB0aW9ucy5hZGQob25EaWRDaGFuZ2UoU0hPV19UWVBFX0NPVkVSQUdFX0NPTkZJR19QQVRILFxuICAgICAgKGRlbHRhOiB7bmV3VmFsdWU6IGJvb2xlYW47IG9sZFZhbHVlOiBib29sZWFufSkgPT4ge1xuICAgICAgICBpZiAoZGVsdGEubmV3VmFsdWUpIHtcbiAgICAgICAgICBlbmFibGVDb3ZlcmFnZVByb3ZpZGVyKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGlzYWJsZUNvdmVyYWdlUHJvdmlkZXIoKTtcbiAgICAgICAgfVxuICAgICAgfSkpO1xuICAgIHN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJyxcbiAgICAgICAgJ251Y2xpZGUtaGFjazp0b2dnbGUtdHlwZS1jb3ZlcmFnZScsIHRvZ2dsZVR5cGVDb3ZlcmFnZSkpO1xuXG4gICAgaWYgKGdldFNob3dUeXBlQ292ZXJhZ2UoKSkge1xuICAgICAgZW5hYmxlQ292ZXJhZ2VQcm92aWRlcigpO1xuICAgIH1cbiAgfSxcblxuICAvKiogUHJvdmlkZXIgZm9yIGF1dG9jb21wbGV0ZSBzZXJ2aWNlLiAqL1xuICBjcmVhdGVBdXRvY29tcGxldGVQcm92aWRlcigpOiBhdG9tJEF1dG9jb21wbGV0ZVByb3ZpZGVyIHtcbiAgICBjb25zdCBBdXRvY29tcGxldGVQcm92aWRlciA9IHJlcXVpcmUoJy4vQXV0b2NvbXBsZXRlUHJvdmlkZXInKTtcbiAgICBjb25zdCBhdXRvY29tcGxldGVQcm92aWRlciA9IG5ldyBBdXRvY29tcGxldGVQcm92aWRlcigpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbGVjdG9yOiBIQUNLX0dSQU1NQVJTLm1hcChncmFtbWFyID0+ICcuJyArIGdyYW1tYXIpLmpvaW4oJywgJyksXG4gICAgICBpbmNsdXNpb25Qcmlvcml0eTogMSxcbiAgICAgIC8vIFRoZSBjb250ZXh0LXNlbnNpdGl2ZSBoYWNrIGF1dG9jb21wbGV0aW9ucyBhcmUgbW9yZSByZWxldmFudCB0aGFuIHNuaXBwZXRzLlxuICAgICAgc3VnZ2VzdGlvblByaW9yaXR5OiAzLFxuICAgICAgZXhjbHVkZUxvd2VyUHJpb3JpdHk6IGZhbHNlLFxuXG4gICAgICBnZXRTdWdnZXN0aW9ucyhcbiAgICAgICAgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0LFxuICAgICAgKTogUHJvbWlzZTw/QXJyYXk8YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uPj4ge1xuICAgICAgICByZXR1cm4gYXV0b2NvbXBsZXRlUHJvdmlkZXIuZ2V0QXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnMocmVxdWVzdCk7XG4gICAgICB9LFxuICAgIH07XG4gIH0sXG5cbiAgZ2V0SHlwZXJjbGlja1Byb3ZpZGVyKCk6IEh5cGVyY2xpY2tQcm92aWRlciB7XG4gICAgY29uc3QgSGFja0h5cGVyY2xpY2tQcm92aWRlciA9IHJlcXVpcmUoJy4vSHlwZXJjbGlja1Byb3ZpZGVyJyk7XG4gICAgY29uc3QgaGFja0h5cGVyY2xpY2tQcm92aWRlciA9IG5ldyBIYWNrSHlwZXJjbGlja1Byb3ZpZGVyKCk7XG4gICAgY29uc3QgZ2V0U3VnZ2VzdGlvbkZvcldvcmQgPVxuICAgICAgICBoYWNrSHlwZXJjbGlja1Byb3ZpZGVyLmdldFN1Z2dlc3Rpb25Gb3JXb3JkLmJpbmQoaGFja0h5cGVyY2xpY2tQcm92aWRlcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHByaW9yaXR5OiAyMCxcbiAgICAgIHByb3ZpZGVyTmFtZTogUEFDS0FHRV9OQU1FLFxuICAgICAgZ2V0U3VnZ2VzdGlvbkZvcldvcmQsXG4gICAgfTtcbiAgfSxcblxuICAvKiogUHJvdmlkZXIgZm9yIGNvZGUgZm9ybWF0IHNlcnZpY2UuICovXG4gIGNyZWF0ZUNvZGVGb3JtYXRQcm92aWRlcigpOiBhbnkge1xuICAgIGNvbnN0IENvZGVGb3JtYXRQcm92aWRlciA9IHJlcXVpcmUoJy4vQ29kZUZvcm1hdFByb3ZpZGVyJyk7XG4gICAgY29uc3QgY29kZUZvcm1hdFByb3ZpZGVyID0gbmV3IENvZGVGb3JtYXRQcm92aWRlcigpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbGVjdG9yOiBIQUNLX0dSQU1NQVJTX1NUUklORyxcbiAgICAgIGluY2x1c2lvblByaW9yaXR5OiAxLFxuXG4gICAgICBmb3JtYXRDb2RlKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCByYW5nZTogYXRvbSRSYW5nZSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIHJldHVybiBjb2RlRm9ybWF0UHJvdmlkZXIuZm9ybWF0Q29kZShlZGl0b3IsIHJhbmdlKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfSxcblxuICBjcmVhdGVGaW5kUmVmZXJlbmNlc1Byb3ZpZGVyKCk6IGFueSB7XG4gICAgcmV0dXJuIHJlcXVpcmUoJy4vRmluZFJlZmVyZW5jZXNQcm92aWRlcicpO1xuICB9LFxuXG4gIGNyZWF0ZVR5cGVIaW50UHJvdmlkZXIoKTogYW55IHtcbiAgICBjb25zdCBUeXBlSGludFByb3ZpZGVyID0gcmVxdWlyZSgnLi9UeXBlSGludFByb3ZpZGVyJyk7XG4gICAgY29uc3QgdHlwZUhpbnRQcm92aWRlciA9IG5ldyBUeXBlSGludFByb3ZpZGVyKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc2VsZWN0b3I6IEhBQ0tfR1JBTU1BUlNfU1RSSU5HLFxuICAgICAgaW5jbHVzaW9uUHJpb3JpdHk6IDEsXG4gICAgICBwcm92aWRlck5hbWU6IFBBQ0tBR0VfTkFNRSxcblxuICAgICAgdHlwZUhpbnQoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHBvc2l0aW9uOiBhdG9tJFBvaW50KTogUHJvbWlzZTw/VHlwZUhpbnQ+IHtcbiAgICAgICAgcmV0dXJuIHR5cGVIaW50UHJvdmlkZXIudHlwZUhpbnQoZWRpdG9yLCBwb3NpdGlvbik7XG4gICAgICB9LFxuICAgIH07XG4gIH0sXG5cbiAgY3JlYXRlQ29kZUhpZ2hsaWdodFByb3ZpZGVyKCk6IGFueSB7XG4gICAgY29uc3QgY29kZUhpZ2hsaWdodFByb3ZpZGVyID0gbmV3IENvZGVIaWdobGlnaHRQcm92aWRlcigpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbGVjdG9yOiBIQUNLX0dSQU1NQVJTX1NUUklORyxcbiAgICAgIGluY2x1c2lvblByaW9yaXR5OiAxLFxuICAgICAgaGlnaGxpZ2h0KGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCBwb3NpdGlvbjogYXRvbSRQb2ludCk6IFByb21pc2U8QXJyYXk8YXRvbSRSYW5nZT4+IHtcbiAgICAgICAgcmV0dXJuIGNvZGVIaWdobGlnaHRQcm92aWRlci5oaWdobGlnaHQoZWRpdG9yLCBwb3NpdGlvbik7XG4gICAgICB9LFxuICAgIH07XG4gIH0sXG5cbiAgcHJvdmlkZURpYWdub3N0aWNzKCkge1xuICAgIGlmICghaGFja0RpYWdub3N0aWNzUHJvdmlkZXIpIHtcbiAgICAgIGNvbnN0IEhhY2tEaWFnbm9zdGljc1Byb3ZpZGVyID0gcmVxdWlyZSgnLi9IYWNrRGlhZ25vc3RpY3NQcm92aWRlcicpO1xuICAgICAgY29uc3QgYnVzeVByb3ZpZGVyID0gcHJvdmlkZUJ1c3lTaWduYWwoKTtcbiAgICAgIGhhY2tEaWFnbm9zdGljc1Byb3ZpZGVyID0gbmV3IEhhY2tEaWFnbm9zdGljc1Byb3ZpZGVyKGZhbHNlLCBidXN5UHJvdmlkZXIpO1xuICAgIH1cbiAgICByZXR1cm4gaGFja0RpYWdub3N0aWNzUHJvdmlkZXI7XG4gIH0sXG5cbiAgZGVhY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICBpZiAoc3Vic2NyaXB0aW9ucykge1xuICAgICAgc3Vic2NyaXB0aW9ucy5kaXNwb3NlKCk7XG4gICAgICBzdWJzY3JpcHRpb25zID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKGhhY2tEaWFnbm9zdGljc1Byb3ZpZGVyKSB7XG4gICAgICBoYWNrRGlhZ25vc3RpY3NQcm92aWRlci5kaXNwb3NlKCk7XG4gICAgICBoYWNrRGlhZ25vc3RpY3NQcm92aWRlciA9IG51bGw7XG4gICAgfVxuICAgIGRpc2FibGVDb3ZlcmFnZVByb3ZpZGVyKCk7XG4gIH0sXG59O1xuXG5mdW5jdGlvbiBwcm92aWRlQnVzeVNpZ25hbCgpOiBCdXN5U2lnbmFsUHJvdmlkZXJCYXNlVHlwZSB7XG4gIGlmIChidXN5U2lnbmFsUHJvdmlkZXIgPT0gbnVsbCkge1xuICAgIGNvbnN0IHtCdXN5U2lnbmFsUHJvdmlkZXJCYXNlfSA9IHJlcXVpcmUoJy4uLy4uL2J1c3ktc2lnbmFsLXByb3ZpZGVyLWJhc2UnKTtcbiAgICBidXN5U2lnbmFsUHJvdmlkZXIgPSBuZXcgQnVzeVNpZ25hbFByb3ZpZGVyQmFzZSgpO1xuICB9XG4gIHJldHVybiBidXN5U2lnbmFsUHJvdmlkZXI7XG59XG5cbmZ1bmN0aW9uIGVuYWJsZUNvdmVyYWdlUHJvdmlkZXIoKTogdm9pZCB7XG4gIGlmIChjb3ZlcmFnZVByb3ZpZGVyID09IG51bGwpIHtcbiAgICBjb3ZlcmFnZVByb3ZpZGVyID0gbmV3IFR5cGVDb3ZlcmFnZVByb3ZpZGVyKHByb3ZpZGVCdXN5U2lnbmFsKCkpO1xuICAgIGludmFyaWFudChoYWNrVHlwZUNvdmVyYWdlUHJvdmlkZXJTdWJzY3JpcHRpb24gPT0gbnVsbCk7XG4gICAgaGFja1R5cGVDb3ZlcmFnZVByb3ZpZGVyU3Vic2NyaXB0aW9uID0gYXRvbS5wYWNrYWdlcy5zZXJ2aWNlSHViLnByb3ZpZGUoXG4gICAgICAnbnVjbGlkZS1kaWFnbm9zdGljcy1wcm92aWRlcicsICcwLjEuMCcsXG4gICAgICBjb3ZlcmFnZVByb3ZpZGVyKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBkaXNhYmxlQ292ZXJhZ2VQcm92aWRlcigpOiB2b2lkIHtcbiAgaWYgKGhhY2tUeXBlQ292ZXJhZ2VQcm92aWRlclN1YnNjcmlwdGlvbiAhPSBudWxsKSB7XG4gICAgaGFja1R5cGVDb3ZlcmFnZVByb3ZpZGVyU3Vic2NyaXB0aW9uLmRpc3Bvc2UoKTtcbiAgICBoYWNrVHlwZUNvdmVyYWdlUHJvdmlkZXJTdWJzY3JpcHRpb24gPSBudWxsO1xuICB9XG4gIGlmIChjb3ZlcmFnZVByb3ZpZGVyICE9IG51bGwpIHtcbiAgICBjb3ZlcmFnZVByb3ZpZGVyLmRpc3Bvc2UoKTtcbiAgICBjb3ZlcmFnZVByb3ZpZGVyID0gbnVsbDtcbiAgfVxufVxuXG5mdW5jdGlvbiB0b2dnbGVUeXBlQ292ZXJhZ2UoKTogdm9pZCB7XG4gIHNldFNob3dUeXBlQ292ZXJhZ2UoIWdldFNob3dUeXBlQ292ZXJhZ2UoKSk7XG59XG4iXX0=