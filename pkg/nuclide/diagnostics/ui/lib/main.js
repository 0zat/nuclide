function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _atom = require('atom');

var DEFAULT_HIDE_DIAGNOSTICS_PANEL = true;
var DEFAULT_TABLE_HEIGHT = 200;
var DEFAULT_FILTER_BY_ACTIVE_EDITOR = false;
var LINTER_PACKAGE = 'linter';

var subscriptions = null;
var bottomPanel = null;
var getDiagnosticsPanel = undefined;
var statusBarTile = undefined;

var activationState = null;

var diagnosticUpdaterForTable = null;

function createPanel(diagnosticUpdater, disposables) {
  (0, _assert2['default'])(activationState);

  var _require$createDiagnosticsPanel = require('./createPanel').createDiagnosticsPanel(diagnosticUpdater, activationState.diagnosticsPanelHeight, activationState.filterByActiveTextEditor, disableLinter);

  var panel = _require$createDiagnosticsPanel.atomPanel;
  var getDiagnosticsPanelFn = _require$createDiagnosticsPanel.getDiagnosticsPanel;
  var setWarnAboutLinter = _require$createDiagnosticsPanel.setWarnAboutLinter;

  logPanelIsDisplayed();
  bottomPanel = panel;
  getDiagnosticsPanel = getDiagnosticsPanelFn;

  activationState.hideDiagnosticsPanel = false;

  var onDidChangeVisibleSubscription = panel.onDidChangeVisible(function (visible) {
    (0, _assert2['default'])(activationState);
    activationState.hideDiagnosticsPanel = !visible;
  });
  disposables.add(onDidChangeVisibleSubscription);

  watchForLinter(setWarnAboutLinter, disposables);
}

function disableLinter() {
  atom.packages.disablePackage(LINTER_PACKAGE);
}

function watchForLinter(setWarnAboutLinter, disposables) {
  if (atom.packages.isPackageActive(LINTER_PACKAGE)) {
    setWarnAboutLinter(true);
  }
  disposables.add(atom.packages.onDidActivatePackage(function (pkg) {
    if (pkg.name === LINTER_PACKAGE) {
      setWarnAboutLinter(true);
    }
  }));
  disposables.add(atom.packages.onDidDeactivatePackage(function (pkg) {
    if (pkg.name === LINTER_PACKAGE) {
      setWarnAboutLinter(false);
    }
  }));
}

function getStatusBarTile() {
  if (!statusBarTile) {
    statusBarTile = new (require('./StatusBarTile'))();
  }
  return statusBarTile;
}

function tryRecordActivationState() {
  (0, _assert2['default'])(activationState);
  if (bottomPanel && bottomPanel.isVisible()) {
    activationState.diagnosticsPanelHeight = bottomPanel.getItem().clientHeight;

    (0, _assert2['default'])(getDiagnosticsPanel);
    var diagnosticsPanel = getDiagnosticsPanel();
    if (diagnosticsPanel) {
      activationState.filterByActiveTextEditor = diagnosticsPanel.props.filterByActiveTextEditor;
    }
  }
}

var toolBar = null;

module.exports = {
  activate: function activate(state) {
    if (subscriptions) {
      return;
    }
    subscriptions = new _atom.CompositeDisposable();

    // Ensure the integrity of the ActivationState created from state.
    if (!state) {
      state = {};
    }
    if (typeof state.hideDiagnosticsPanel !== 'boolean') {
      state.hideDiagnosticsPanel = DEFAULT_HIDE_DIAGNOSTICS_PANEL;
    }
    if (typeof state.diagnosticsPanelHeight !== 'number') {
      state.diagnosticsPanelHeight = DEFAULT_TABLE_HEIGHT;
    }
    if (typeof state.filterByActiveTextEditor !== 'boolean') {
      state.filterByActiveTextEditor = DEFAULT_FILTER_BY_ACTIVE_EDITOR;
    }
    activationState = state;
  },

  consumeDiagnosticUpdates: function consumeDiagnosticUpdates(diagnosticUpdater) {
    getStatusBarTile().consumeDiagnosticUpdates(diagnosticUpdater);

    var _require = require('./gutter');

    var applyUpdateToEditor = _require.applyUpdateToEditor;

    var fixer = diagnosticUpdater.applyFix.bind(diagnosticUpdater);

    (0, _assert2['default'])(subscriptions);
    subscriptions.add(atom.workspace.observeTextEditors(function (editor) {
      var filePath = editor.getPath();
      if (!filePath) {
        return; // The file is likely untitled.
      }

      var callback = function callback(update) {
        applyUpdateToEditor(editor, update, fixer);
      };
      var disposable = diagnosticUpdater.onFileMessagesDidUpdate(callback, filePath);

      // Be sure to remove the subscription on the DiagnosticStore once the editor is closed.
      editor.onDidDestroy(function () {
        return disposable.dispose();
      });
    }));

    // Currently, the DiagnosticsPanel is designed to work with only one DiagnosticUpdater.
    // Therefore, we only create a DiagnosticsPanel for the first call to consumeDiagnosticUpdates.
    if (diagnosticUpdaterForTable) {
      return;
    }
    diagnosticUpdaterForTable = diagnosticUpdater;

    var lazilyCreateTable = createPanel.bind(null, diagnosticUpdater, subscriptions);

    var toggleTable = function toggleTable() {
      var bottomPanelRef = bottomPanel;
      if (bottomPanelRef == null) {
        lazilyCreateTable();
      } else if (bottomPanelRef.isVisible()) {
        tryRecordActivationState();
        bottomPanelRef.hide();
      } else {
        logPanelIsDisplayed();
        bottomPanelRef.show();
      }
    };

    var showTable = function showTable() {
      if (bottomPanel == null || !bottomPanel.isVisible()) {
        toggleTable();
      }
    };

    subscriptions.add(atom.commands.add(atom.views.getView(atom.workspace), 'nuclide-diagnostics-ui:toggle-table', toggleTable));

    subscriptions.add(atom.commands.add(atom.views.getView(atom.workspace), 'nuclide-diagnostics-ui:show-table', showTable));

    (0, _assert2['default'])(activationState);
    if (!activationState.hideDiagnosticsPanel) {
      lazilyCreateTable();
    }
  },

  consumeStatusBar: function consumeStatusBar(statusBar) {
    getStatusBarTile().consumeStatusBar(statusBar);
  },

  consumeToolBar: function consumeToolBar(getToolBar) {
    toolBar = getToolBar('nuclide-diagnostics-ui');
    toolBar.addButton({
      icon: 'law',
      callback: 'nuclide-diagnostics-ui:toggle-table',
      tooltip: 'Toggle Diagnostics Table',
      priority: 200
    });
  },

  deactivate: function deactivate() {
    if (subscriptions) {
      subscriptions.dispose();
      subscriptions = null;
    }

    if (bottomPanel) {
      bottomPanel.destroy();
      bottomPanel = null;
    }

    if (statusBarTile) {
      statusBarTile.dispose();
      statusBarTile = null;
    }

    if (toolBar) {
      toolBar.removeItems();
    }

    diagnosticUpdaterForTable = null;
  },

  serialize: function serialize() {
    tryRecordActivationState();
    (0, _assert2['default'])(activationState);
    return activationState;
  },

  getHomeFragments: function getHomeFragments() {
    return {
      feature: {
        title: 'Diagnostics',
        icon: 'law',
        description: 'Displays diagnostics, errors, and lint warnings for your files and projects.',
        command: 'nuclide-diagnostics-ui:show-table'
      },
      priority: 4
    };
  }

};

function logPanelIsDisplayed() {
  var _require2 = require('../../../analytics');

  var track = _require2.track;

  track('diagnostics-show-table');
}
//# sourceMappingURL=data:application/json;base64,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QUEwQjtBQUNuQyxjQUFRLEVBQUUsR0FBRztLQUNkLENBQUMsQ0FBQztHQUNKOztBQUVELFlBQVUsRUFBQSxzQkFBUztBQUNqQixRQUFJLGFBQWEsRUFBRTtBQUNqQixtQkFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3hCLG1CQUFhLEdBQUcsSUFBSSxDQUFDO0tBQ3RCOztBQUVELFFBQUksV0FBVyxFQUFFO0FBQ2YsaUJBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN0QixpQkFBVyxHQUFHLElBQUksQ0FBQztLQUNwQjs7QUFFRCxRQUFJLGFBQWEsRUFBRTtBQUNqQixtQkFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3hCLG1CQUFhLEdBQUcsSUFBSSxDQUFDO0tBQ3RCOztBQUVELFFBQUksT0FBTyxFQUFFO0FBQ1gsYUFBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO0tBQ3ZCOztBQUVELDZCQUF5QixHQUFHLElBQUksQ0FBQztHQUNsQzs7QUFFRCxXQUFTLEVBQUEscUJBQW9CO0FBQzNCLDRCQUF3QixFQUFFLENBQUM7QUFDM0IsNkJBQVUsZUFBZSxDQUFDLENBQUM7QUFDM0IsV0FBTyxlQUFlLENBQUM7R0FDeEI7O0FBRUQsa0JBQWdCLEVBQUEsNEJBQWtCO0FBQ2hDLFdBQU87QUFDTCxhQUFPLEVBQUU7QUFDUCxhQUFLLEVBQUUsYUFBYTtBQUNwQixZQUFJLEVBQUUsS0FBSztBQUNYLG1CQUFXLEVBQUUsOEVBQThFO0FBQzNGLGVBQU8sRUFBRSxtQ0FBbUM7T0FDN0M7QUFDRCxjQUFRLEVBQUUsQ0FBQztLQUNaLENBQUM7R0FDSDs7Q0FFRixDQUFDOztBQUVGLFNBQVMsbUJBQW1CLEdBQUc7a0JBQ2IsT0FBTyxDQUFDLG9CQUFvQixDQUFDOztNQUF0QyxLQUFLLGFBQUwsS0FBSzs7QUFDWixPQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztDQUNqQyIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuaW1wb3J0IHR5cGUge0RpYWdub3N0aWNVcGRhdGVyLCBGaWxlTWVzc2FnZVVwZGF0ZX0gZnJvbSAnLi4vLi4vYmFzZSc7XG5cbmltcG9ydCBpbnZhcmlhbnQgZnJvbSAnYXNzZXJ0JztcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XG5cbmltcG9ydCB0eXBlIERpYWdub3N0aWNzUGFuZWwgZnJvbSAnLi9EaWFnbm9zdGljc1BhbmVsJztcbmltcG9ydCB0eXBlIFN0YXR1c0JhclRpbGUgZnJvbSAnLi9TdGF0dXNCYXJUaWxlJztcbmltcG9ydCB0eXBlIHtIb21lRnJhZ21lbnRzfSBmcm9tICcuLi8uLi8uLi9ob21lLWludGVyZmFjZXMnO1xuXG5jb25zdCBERUZBVUxUX0hJREVfRElBR05PU1RJQ1NfUEFORUwgPSB0cnVlO1xuY29uc3QgREVGQVVMVF9UQUJMRV9IRUlHSFQgPSAyMDA7XG5jb25zdCBERUZBVUxUX0ZJTFRFUl9CWV9BQ1RJVkVfRURJVE9SID0gZmFsc2U7XG5jb25zdCBMSU5URVJfUEFDS0FHRSA9ICdsaW50ZXInO1xuXG5sZXQgc3Vic2NyaXB0aW9uczogP0NvbXBvc2l0ZURpc3Bvc2FibGUgPSBudWxsO1xubGV0IGJvdHRvbVBhbmVsOiA/YXRvbSRQYW5lbCA9IG51bGw7XG5sZXQgZ2V0RGlhZ25vc3RpY3NQYW5lbDogPygoKSA9PiA/RGlhZ25vc3RpY3NQYW5lbCk7XG5sZXQgc3RhdHVzQmFyVGlsZTogP1N0YXR1c0JhclRpbGU7XG5cbnR5cGUgQWN0aXZhdGlvblN0YXRlID0ge1xuICBoaWRlRGlhZ25vc3RpY3NQYW5lbDogYm9vbGVhbjtcbiAgZGlhZ25vc3RpY3NQYW5lbEhlaWdodDogbnVtYmVyO1xuICBmaWx0ZXJCeUFjdGl2ZVRleHRFZGl0b3I6IGJvb2xlYW47XG59O1xuXG5sZXQgYWN0aXZhdGlvblN0YXRlOiA/QWN0aXZhdGlvblN0YXRlID0gbnVsbDtcblxubGV0IGRpYWdub3N0aWNVcGRhdGVyRm9yVGFibGU6ID9EaWFnbm9zdGljVXBkYXRlciA9IG51bGw7XG5cbmZ1bmN0aW9uIGNyZWF0ZVBhbmVsKGRpYWdub3N0aWNVcGRhdGVyOiBEaWFnbm9zdGljVXBkYXRlciwgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUpIHtcbiAgaW52YXJpYW50KGFjdGl2YXRpb25TdGF0ZSk7XG4gIGNvbnN0IHtcbiAgICBhdG9tUGFuZWw6IHBhbmVsLFxuICAgIGdldERpYWdub3N0aWNzUGFuZWw6IGdldERpYWdub3N0aWNzUGFuZWxGbixcbiAgICBzZXRXYXJuQWJvdXRMaW50ZXIsXG4gIH0gPSByZXF1aXJlKCcuL2NyZWF0ZVBhbmVsJykuY3JlYXRlRGlhZ25vc3RpY3NQYW5lbChcbiAgICBkaWFnbm9zdGljVXBkYXRlcixcbiAgICBhY3RpdmF0aW9uU3RhdGUuZGlhZ25vc3RpY3NQYW5lbEhlaWdodCxcbiAgICBhY3RpdmF0aW9uU3RhdGUuZmlsdGVyQnlBY3RpdmVUZXh0RWRpdG9yLFxuICAgIGRpc2FibGVMaW50ZXIpO1xuICBsb2dQYW5lbElzRGlzcGxheWVkKCk7XG4gIGJvdHRvbVBhbmVsID0gcGFuZWw7XG4gIGdldERpYWdub3N0aWNzUGFuZWwgPSBnZXREaWFnbm9zdGljc1BhbmVsRm47XG5cbiAgYWN0aXZhdGlvblN0YXRlLmhpZGVEaWFnbm9zdGljc1BhbmVsID0gZmFsc2U7XG5cbiAgY29uc3Qgb25EaWRDaGFuZ2VWaXNpYmxlU3Vic2NyaXB0aW9uID0gcGFuZWwub25EaWRDaGFuZ2VWaXNpYmxlKCh2aXNpYmxlOiBib29sZWFuKSA9PiB7XG4gICAgaW52YXJpYW50KGFjdGl2YXRpb25TdGF0ZSk7XG4gICAgYWN0aXZhdGlvblN0YXRlLmhpZGVEaWFnbm9zdGljc1BhbmVsID0gIXZpc2libGU7XG4gIH0pO1xuICBkaXNwb3NhYmxlcy5hZGQob25EaWRDaGFuZ2VWaXNpYmxlU3Vic2NyaXB0aW9uKTtcblxuICB3YXRjaEZvckxpbnRlcihzZXRXYXJuQWJvdXRMaW50ZXIsIGRpc3Bvc2FibGVzKTtcbn1cblxuZnVuY3Rpb24gZGlzYWJsZUxpbnRlcigpIHtcbiAgYXRvbS5wYWNrYWdlcy5kaXNhYmxlUGFja2FnZShMSU5URVJfUEFDS0FHRSk7XG59XG5cbmZ1bmN0aW9uIHdhdGNoRm9yTGludGVyKFxuICAgIHNldFdhcm5BYm91dExpbnRlcjogKHdhcm46IGJvb2xlYW4pID0+IHZvaWQsXG4gICAgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUpOiB2b2lkIHtcbiAgaWYgKGF0b20ucGFja2FnZXMuaXNQYWNrYWdlQWN0aXZlKExJTlRFUl9QQUNLQUdFKSkge1xuICAgIHNldFdhcm5BYm91dExpbnRlcih0cnVlKTtcbiAgfVxuICBkaXNwb3NhYmxlcy5hZGQoYXRvbS5wYWNrYWdlcy5vbkRpZEFjdGl2YXRlUGFja2FnZShwa2cgPT4ge1xuICAgIGlmIChwa2cubmFtZSA9PT0gTElOVEVSX1BBQ0tBR0UpIHtcbiAgICAgIHNldFdhcm5BYm91dExpbnRlcih0cnVlKTtcbiAgICB9XG4gIH0pKTtcbiAgZGlzcG9zYWJsZXMuYWRkKGF0b20ucGFja2FnZXMub25EaWREZWFjdGl2YXRlUGFja2FnZShwa2cgPT4ge1xuICAgIGlmIChwa2cubmFtZSA9PT0gTElOVEVSX1BBQ0tBR0UpIHtcbiAgICAgIHNldFdhcm5BYm91dExpbnRlcihmYWxzZSk7XG4gICAgfVxuICB9KSk7XG59XG5cbmZ1bmN0aW9uIGdldFN0YXR1c0JhclRpbGUoKTogU3RhdHVzQmFyVGlsZSB7XG4gIGlmICghc3RhdHVzQmFyVGlsZSkge1xuICAgIHN0YXR1c0JhclRpbGUgPSBuZXcgKHJlcXVpcmUoJy4vU3RhdHVzQmFyVGlsZScpKSgpO1xuICB9XG4gIHJldHVybiBzdGF0dXNCYXJUaWxlO1xufVxuXG5mdW5jdGlvbiB0cnlSZWNvcmRBY3RpdmF0aW9uU3RhdGUoKTogdm9pZCB7XG4gIGludmFyaWFudChhY3RpdmF0aW9uU3RhdGUpO1xuICBpZiAoYm90dG9tUGFuZWwgJiYgYm90dG9tUGFuZWwuaXNWaXNpYmxlKCkpIHtcbiAgICBhY3RpdmF0aW9uU3RhdGUuZGlhZ25vc3RpY3NQYW5lbEhlaWdodCA9IGJvdHRvbVBhbmVsLmdldEl0ZW0oKS5jbGllbnRIZWlnaHQ7XG5cbiAgICBpbnZhcmlhbnQoZ2V0RGlhZ25vc3RpY3NQYW5lbCk7XG4gICAgY29uc3QgZGlhZ25vc3RpY3NQYW5lbCA9IGdldERpYWdub3N0aWNzUGFuZWwoKTtcbiAgICBpZiAoZGlhZ25vc3RpY3NQYW5lbCkge1xuICAgICAgYWN0aXZhdGlvblN0YXRlLmZpbHRlckJ5QWN0aXZlVGV4dEVkaXRvciA9IGRpYWdub3N0aWNzUGFuZWwucHJvcHMuZmlsdGVyQnlBY3RpdmVUZXh0RWRpdG9yO1xuICAgIH1cbiAgfVxufVxuXG5sZXQgdG9vbEJhcjogP2FueSA9IG51bGw7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBhY3RpdmF0ZShzdGF0ZTogP09iamVjdCk6IHZvaWQge1xuICAgIGlmIChzdWJzY3JpcHRpb25zKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHN1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuXG4gICAgLy8gRW5zdXJlIHRoZSBpbnRlZ3JpdHkgb2YgdGhlIEFjdGl2YXRpb25TdGF0ZSBjcmVhdGVkIGZyb20gc3RhdGUuXG4gICAgaWYgKCFzdGF0ZSkge1xuICAgICAgc3RhdGUgPSB7fTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBzdGF0ZS5oaWRlRGlhZ25vc3RpY3NQYW5lbCAhPT0gJ2Jvb2xlYW4nKSB7XG4gICAgICBzdGF0ZS5oaWRlRGlhZ25vc3RpY3NQYW5lbCA9IERFRkFVTFRfSElERV9ESUFHTk9TVElDU19QQU5FTDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBzdGF0ZS5kaWFnbm9zdGljc1BhbmVsSGVpZ2h0ICE9PSAnbnVtYmVyJykge1xuICAgICAgc3RhdGUuZGlhZ25vc3RpY3NQYW5lbEhlaWdodCA9IERFRkFVTFRfVEFCTEVfSEVJR0hUO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHN0YXRlLmZpbHRlckJ5QWN0aXZlVGV4dEVkaXRvciAhPT0gJ2Jvb2xlYW4nKSB7XG4gICAgICBzdGF0ZS5maWx0ZXJCeUFjdGl2ZVRleHRFZGl0b3IgPSBERUZBVUxUX0ZJTFRFUl9CWV9BQ1RJVkVfRURJVE9SO1xuICAgIH1cbiAgICBhY3RpdmF0aW9uU3RhdGUgPSBzdGF0ZTtcbiAgfSxcblxuICBjb25zdW1lRGlhZ25vc3RpY1VwZGF0ZXMoZGlhZ25vc3RpY1VwZGF0ZXI6IERpYWdub3N0aWNVcGRhdGVyKTogdm9pZCB7XG4gICAgZ2V0U3RhdHVzQmFyVGlsZSgpLmNvbnN1bWVEaWFnbm9zdGljVXBkYXRlcyhkaWFnbm9zdGljVXBkYXRlcik7XG5cbiAgICBjb25zdCB7YXBwbHlVcGRhdGVUb0VkaXRvcn0gPSByZXF1aXJlKCcuL2d1dHRlcicpO1xuXG4gICAgY29uc3QgZml4ZXIgPSBkaWFnbm9zdGljVXBkYXRlci5hcHBseUZpeC5iaW5kKGRpYWdub3N0aWNVcGRhdGVyKTtcblxuICAgIGludmFyaWFudChzdWJzY3JpcHRpb25zKTtcbiAgICBzdWJzY3JpcHRpb25zLmFkZChhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoKGVkaXRvcjogVGV4dEVkaXRvcikgPT4ge1xuICAgICAgY29uc3QgZmlsZVBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpO1xuICAgICAgaWYgKCFmaWxlUGF0aCkge1xuICAgICAgICByZXR1cm47IC8vIFRoZSBmaWxlIGlzIGxpa2VseSB1bnRpdGxlZC5cbiAgICAgIH1cblxuICAgICAgY29uc3QgY2FsbGJhY2sgPSAodXBkYXRlOiBGaWxlTWVzc2FnZVVwZGF0ZSkgPT4ge1xuICAgICAgICBhcHBseVVwZGF0ZVRvRWRpdG9yKGVkaXRvciwgdXBkYXRlLCBmaXhlcik7XG4gICAgICB9O1xuICAgICAgY29uc3QgZGlzcG9zYWJsZSA9IGRpYWdub3N0aWNVcGRhdGVyLm9uRmlsZU1lc3NhZ2VzRGlkVXBkYXRlKGNhbGxiYWNrLCBmaWxlUGF0aCk7XG5cbiAgICAgIC8vIEJlIHN1cmUgdG8gcmVtb3ZlIHRoZSBzdWJzY3JpcHRpb24gb24gdGhlIERpYWdub3N0aWNTdG9yZSBvbmNlIHRoZSBlZGl0b3IgaXMgY2xvc2VkLlxuICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiBkaXNwb3NhYmxlLmRpc3Bvc2UoKSk7XG4gICAgfSkpO1xuXG4gICAgLy8gQ3VycmVudGx5LCB0aGUgRGlhZ25vc3RpY3NQYW5lbCBpcyBkZXNpZ25lZCB0byB3b3JrIHdpdGggb25seSBvbmUgRGlhZ25vc3RpY1VwZGF0ZXIuXG4gICAgLy8gVGhlcmVmb3JlLCB3ZSBvbmx5IGNyZWF0ZSBhIERpYWdub3N0aWNzUGFuZWwgZm9yIHRoZSBmaXJzdCBjYWxsIHRvIGNvbnN1bWVEaWFnbm9zdGljVXBkYXRlcy5cbiAgICBpZiAoZGlhZ25vc3RpY1VwZGF0ZXJGb3JUYWJsZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkaWFnbm9zdGljVXBkYXRlckZvclRhYmxlID0gZGlhZ25vc3RpY1VwZGF0ZXI7XG5cbiAgICBjb25zdCBsYXppbHlDcmVhdGVUYWJsZSA9IGNyZWF0ZVBhbmVsLmJpbmQobnVsbCwgZGlhZ25vc3RpY1VwZGF0ZXIsIHN1YnNjcmlwdGlvbnMpO1xuXG4gICAgY29uc3QgdG9nZ2xlVGFibGUgPSAoKSA9PiB7XG4gICAgICBjb25zdCBib3R0b21QYW5lbFJlZiA9IGJvdHRvbVBhbmVsO1xuICAgICAgaWYgKGJvdHRvbVBhbmVsUmVmID09IG51bGwpIHtcbiAgICAgICAgbGF6aWx5Q3JlYXRlVGFibGUoKTtcbiAgICAgIH0gZWxzZSBpZiAoYm90dG9tUGFuZWxSZWYuaXNWaXNpYmxlKCkpIHtcbiAgICAgICAgdHJ5UmVjb3JkQWN0aXZhdGlvblN0YXRlKCk7XG4gICAgICAgIGJvdHRvbVBhbmVsUmVmLmhpZGUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ1BhbmVsSXNEaXNwbGF5ZWQoKTtcbiAgICAgICAgYm90dG9tUGFuZWxSZWYuc2hvdygpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBzaG93VGFibGUgPSAoKSA9PiB7XG4gICAgICBpZiAoYm90dG9tUGFuZWwgPT0gbnVsbCB8fCAhYm90dG9tUGFuZWwuaXNWaXNpYmxlKCkpIHtcbiAgICAgICAgdG9nZ2xlVGFibGUoKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc3Vic2NyaXB0aW9ucy5hZGQoYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgICBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpLFxuICAgICAgJ251Y2xpZGUtZGlhZ25vc3RpY3MtdWk6dG9nZ2xlLXRhYmxlJyxcbiAgICAgIHRvZ2dsZVRhYmxlLFxuICAgICkpO1xuXG4gICAgc3Vic2NyaXB0aW9ucy5hZGQoYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgICBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpLFxuICAgICAgJ251Y2xpZGUtZGlhZ25vc3RpY3MtdWk6c2hvdy10YWJsZScsXG4gICAgICBzaG93VGFibGUsXG4gICAgKSk7XG5cbiAgICBpbnZhcmlhbnQoYWN0aXZhdGlvblN0YXRlKTtcbiAgICBpZiAoIWFjdGl2YXRpb25TdGF0ZS5oaWRlRGlhZ25vc3RpY3NQYW5lbCkge1xuICAgICAgbGF6aWx5Q3JlYXRlVGFibGUoKTtcbiAgICB9XG4gIH0sXG5cbiAgY29uc3VtZVN0YXR1c0JhcihzdGF0dXNCYXI6IGF0b20kU3RhdHVzQmFyKTogdm9pZCB7XG4gICAgZ2V0U3RhdHVzQmFyVGlsZSgpLmNvbnN1bWVTdGF0dXNCYXIoc3RhdHVzQmFyKTtcbiAgfSxcblxuICBjb25zdW1lVG9vbEJhcihnZXRUb29sQmFyOiAoZ3JvdXA6IHN0cmluZykgPT4gT2JqZWN0KTogdm9pZCB7XG4gICAgdG9vbEJhciA9IGdldFRvb2xCYXIoJ251Y2xpZGUtZGlhZ25vc3RpY3MtdWknKTtcbiAgICB0b29sQmFyLmFkZEJ1dHRvbih7XG4gICAgICBpY29uOiAnbGF3JyxcbiAgICAgIGNhbGxiYWNrOiAnbnVjbGlkZS1kaWFnbm9zdGljcy11aTp0b2dnbGUtdGFibGUnLFxuICAgICAgdG9vbHRpcDogJ1RvZ2dsZSBEaWFnbm9zdGljcyBUYWJsZScsXG4gICAgICBwcmlvcml0eTogMjAwLFxuICAgIH0pO1xuICB9LFxuXG4gIGRlYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgaWYgKHN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHN1YnNjcmlwdGlvbnMuZGlzcG9zZSgpO1xuICAgICAgc3Vic2NyaXB0aW9ucyA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKGJvdHRvbVBhbmVsKSB7XG4gICAgICBib3R0b21QYW5lbC5kZXN0cm95KCk7XG4gICAgICBib3R0b21QYW5lbCA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHN0YXR1c0JhclRpbGUpIHtcbiAgICAgIHN0YXR1c0JhclRpbGUuZGlzcG9zZSgpO1xuICAgICAgc3RhdHVzQmFyVGlsZSA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRvb2xCYXIpIHtcbiAgICAgIHRvb2xCYXIucmVtb3ZlSXRlbXMoKTtcbiAgICB9XG5cbiAgICBkaWFnbm9zdGljVXBkYXRlckZvclRhYmxlID0gbnVsbDtcbiAgfSxcblxuICBzZXJpYWxpemUoKTogQWN0aXZhdGlvblN0YXRlIHtcbiAgICB0cnlSZWNvcmRBY3RpdmF0aW9uU3RhdGUoKTtcbiAgICBpbnZhcmlhbnQoYWN0aXZhdGlvblN0YXRlKTtcbiAgICByZXR1cm4gYWN0aXZhdGlvblN0YXRlO1xuICB9LFxuXG4gIGdldEhvbWVGcmFnbWVudHMoKTogSG9tZUZyYWdtZW50cyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZlYXR1cmU6IHtcbiAgICAgICAgdGl0bGU6ICdEaWFnbm9zdGljcycsXG4gICAgICAgIGljb246ICdsYXcnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0Rpc3BsYXlzIGRpYWdub3N0aWNzLCBlcnJvcnMsIGFuZCBsaW50IHdhcm5pbmdzIGZvciB5b3VyIGZpbGVzIGFuZCBwcm9qZWN0cy4nLFxuICAgICAgICBjb21tYW5kOiAnbnVjbGlkZS1kaWFnbm9zdGljcy11aTpzaG93LXRhYmxlJyxcbiAgICAgIH0sXG4gICAgICBwcmlvcml0eTogNCxcbiAgICB9O1xuICB9LFxuXG59O1xuXG5mdW5jdGlvbiBsb2dQYW5lbElzRGlzcGxheWVkKCkge1xuICBjb25zdCB7dHJhY2t9ID0gcmVxdWlyZSgnLi4vLi4vLi4vYW5hbHl0aWNzJyk7XG4gIHRyYWNrKCdkaWFnbm9zdGljcy1zaG93LXRhYmxlJyk7XG59XG4iXX0=