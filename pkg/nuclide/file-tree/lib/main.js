var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _atom = require('atom');

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _featureConfig = require('../../feature-config');

var _featureConfig2 = _interopRequireDefault(_featureConfig);

var _workingSets = require('../../working-sets');

/**
 * Minimum interval (in ms) between onChangeActivePaneItem events before revealing the active pane
 * item in the file tree.
 */
var ACTIVE_PANE_DEBOUNCE_INTERVAL_MS = 150;

var REVEAL_FILE_ON_SWITCH_SETTING = 'nuclide-file-tree.revealFileOnSwitch';

var Activation = (function () {
  function Activation(state) {
    _classCallCheck(this, Activation);

    this._packageState = state;
    this._subscriptions = new _atom.CompositeDisposable();

    var FileTreeController = require('./FileTreeController');
    this._fileTreeController = new FileTreeController(this._packageState);

    var excludeVcsIgnoredPathsSetting = 'core.excludeVcsIgnoredPaths';
    var hideIgnoredNamesSetting = 'nuclide-file-tree.hideIgnoredNames';
    var ignoredNamesSetting = 'core.ignoredNames';
    var prefixKeyNavSetting = 'nuclide-file-tree.allowKeyboardPrefixNavigation';
    var usePreviewTabs = 'tabs.usePreviewTabs';

    this._subscriptions.add(_featureConfig2['default'].observe(prefixKeyNavSetting, this._setPrefixKeyNavSetting.bind(this)), _featureConfig2['default'].observe(REVEAL_FILE_ON_SWITCH_SETTING, this._setRevealOnFileSwitch.bind(this)), atom.config.observe(ignoredNamesSetting, this._setIgnoredNames.bind(this)), _featureConfig2['default'].observe(hideIgnoredNamesSetting, this._setHideIgnoredNames.bind(this)), atom.config.observe(excludeVcsIgnoredPathsSetting, this._setExcludeVcsIgnoredPaths.bind(this)), atom.config.observe(usePreviewTabs, this._setUsePreviewTabs.bind(this)));
  }

  _createClass(Activation, [{
    key: 'dispose',
    value: function dispose() {
      this._deactivate();
      this._subscriptions.dispose();
    }
  }, {
    key: 'serialize',
    value: function serialize() {
      return this._fileTreeController.serialize();
    }
  }, {
    key: 'consumeWorkingSetsStore',
    value: function consumeWorkingSetsStore(workingSetsStore) {
      var _this = this;

      this._fileTreeController.updateWorkingSetsStore(workingSetsStore);
      this._fileTreeController.updateWorkingSet(workingSetsStore.getCurrent());

      var currentSubscription = workingSetsStore.subscribeToCurrent(function (currentWorkingSet) {
        _this._fileTreeController.updateWorkingSet(currentWorkingSet);
      });
      this._subscriptions.add(currentSubscription);

      var rebuildOpenFilesWorkingSet = function rebuildOpenFilesWorkingSet() {
        var openUris = atom.workspace.getTextEditors().filter(function (te) {
          return te.getPath() != null && te.getPath() !== '';
        }).map(function (te) {
          return te.getPath();
        });
        var openFilesWorkingSet = new _workingSets.WorkingSet(openUris);
        _this._fileTreeController.updateOpenFilesWorkingSet(openFilesWorkingSet);
      };

      rebuildOpenFilesWorkingSet();

      var paneObservingDisposable = new _atom.CompositeDisposable();
      paneObservingDisposable.add(atom.workspace.onDidAddPaneItem(rebuildOpenFilesWorkingSet));
      paneObservingDisposable.add(atom.workspace.onDidDestroyPaneItem(rebuildOpenFilesWorkingSet));

      this._subscriptions.add(paneObservingDisposable);

      return new _atom.Disposable(function () {
        _this._fileTreeController.updateWorkingSetsStore(null);
        _this._fileTreeController.updateWorkingSet(new _workingSets.WorkingSet());
        _this._fileTreeController.updateOpenFilesWorkingSet(new _workingSets.WorkingSet());
        paneObservingDisposable.dispose();
        _this._subscriptions.remove(currentSubscription);
        currentSubscription.dispose();
      });
    }
  }, {
    key: '_setExcludeVcsIgnoredPaths',
    value: function _setExcludeVcsIgnoredPaths(excludeVcsIgnoredPaths) {
      this._fileTreeController.setExcludeVcsIgnoredPaths(excludeVcsIgnoredPaths);
    }
  }, {
    key: '_setHideIgnoredNames',
    value: function _setHideIgnoredNames(hideIgnoredNames) {
      this._fileTreeController.setHideIgnoredNames(hideIgnoredNames);
    }
  }, {
    key: '_setIgnoredNames',
    value: function _setIgnoredNames(ignoredNames) {
      var normalizedIgnoredNames = undefined;
      if (ignoredNames === '') {
        normalizedIgnoredNames = [];
      } else if (typeof ignoredNames === 'string') {
        normalizedIgnoredNames = [ignoredNames];
      } else {
        normalizedIgnoredNames = ignoredNames;
      }
      this._fileTreeController.setIgnoredNames(normalizedIgnoredNames);
    }
  }, {
    key: '_setRevealOnFileSwitch',
    value: function _setRevealOnFileSwitch(shouldReveal) {
      var _this2 = this;

      var onWorkspaceDidStopChangingActivePaneItem = require('../../atom-helpers').atomEventDebounce.onWorkspaceDidStopChangingActivePaneItem;

      if (shouldReveal) {
        var reveal = function reveal() {
          _this2._fileTreeController.revealActiveFile( /* showIfHidden */false);
        };
        // Guard against this getting called multiple times
        if (!this._paneItemSubscription) {
          // Debounce tab change events to limit unneeded scrolling when changing or closing tabs
          // in quick succession.
          this._paneItemSubscription = onWorkspaceDidStopChangingActivePaneItem(reveal, ACTIVE_PANE_DEBOUNCE_INTERVAL_MS);
          this._subscriptions.add(this._paneItemSubscription);
        }
      } else {
        // Use a local so Flow can refine the type.
        var paneItemSubscription = this._paneItemSubscription;
        if (paneItemSubscription) {
          this._subscriptions.remove(paneItemSubscription);
          paneItemSubscription.dispose();
          this._paneItemSubscription = null;
        }
      }
    }
  }, {
    key: '_setPrefixKeyNavSetting',
    value: function _setPrefixKeyNavSetting(usePrefixNav) {
      // config is void during startup, signifying no config yet
      if (usePrefixNav == null || !this._fileTreeController) {
        return;
      }
      this._fileTreeController.setUsePrefixNav(usePrefixNav);
    }
  }, {
    key: '_setUsePreviewTabs',
    value: function _setUsePreviewTabs(usePreviewTabs) {
      // config is void during startup, signifying no config yet
      if (usePreviewTabs == null) {
        return;
      }
      this._fileTreeController.setUsePreviewTabs(usePreviewTabs);
    }
  }, {
    key: '_deactivate',
    value: function _deactivate() {
      // Guard against deactivate being called twice
      this._fileTreeController.destroy();
    }
  }]);

  return Activation;
})();

var activation = undefined;
var deserializedState = undefined;
var onDidActivateDisposable = undefined;
var sideBarDisposable = undefined;

function disableTreeViewPackage() {
  if (!atom.packages.isPackageDisabled('tree-view')) {
    // Calling `disablePackage` on a package first *loads* the package. This step must come
    // before calling `unloadPackage`.
    atom.packages.disablePackage('tree-view');
  }

  if (atom.packages.isPackageActive('tree-view')) {
    // Only *inactive* packages can be unloaded. Attempting to unload an active package is
    // considered an exception. Deactivating must come before unloading.
    atom.packages.deactivatePackage('tree-view');
  }

  if (atom.packages.isPackageLoaded('tree-view')) {
    atom.packages.unloadPackage('tree-view');
  }
}

module.exports = {
  activate: function activate(state) {
    (0, _assert2['default'])(activation == null);
    // Disable Atom's bundled 'tree-view' package. If this activation is happening during the
    // normal startup activation, the `onDidActivateInitialPackages` handler below must unload the
    // 'tree-view' because it will have been loaded during startup.
    disableTreeViewPackage();

    // Disabling and unloading Atom's bundled 'tree-view' must happen after activation because this
    // package's `activate` is called during an traversal of all initial packages to activate.
    // Disabling a package during the traversal has no effect if this is a startup load because
    // `PackageManager` does not re-load the list of packages to activate after each iteration.
    onDidActivateDisposable = atom.packages.onDidActivateInitialPackages(function () {
      disableTreeViewPackage();
      onDidActivateDisposable.dispose();
    });

    deserializedState = state;
    activation = new Activation(deserializedState);
  },

  deactivate: function deactivate() {
    var nuclideFeatures = require('../../../../lib/nuclideFeatures');

    // Re-enable Atom's bundled 'tree-view' when this package is disabled to leave the user's
    // environment the way this package found it.
    if (nuclideFeatures.isFeatureDisabled('nuclide-file-tree') && atom.packages.isPackageDisabled('tree-view')) {
      atom.packages.enablePackage('tree-view');
    }

    if (sideBarDisposable != null) {
      sideBarDisposable.dispose();
    }

    if (!onDidActivateDisposable.disposed) {
      onDidActivateDisposable.dispose();
    }

    if (activation) {
      activation.dispose();
      activation = null;
    }
  },

  serialize: function serialize() {
    if (activation) {
      return activation.serialize();
    }
  },

  consumeNuclideSideBar: function consumeNuclideSideBar(sidebar) {
    (0, _assert2['default'])(activation);

    sidebar.registerView({
      getComponent: function getComponent() {
        return require('../components/FileTreeSidebarComponent');
      },
      onDidShow: function onDidShow() {
        // If "Reveal File on Switch" is enabled, ensure the scroll position is synced to where the
        // user expects when the side bar shows the file tree.
        if (_featureConfig2['default'].get(REVEAL_FILE_ON_SWITCH_SETTING)) {
          atom.commands.dispatch(atom.views.getView(atom.workspace), 'nuclide-file-tree:reveal-active-file');
        }
      },
      toggleCommand: 'nuclide-file-tree:toggle',
      viewId: 'nuclide-file-tree'
    });

    sideBarDisposable = new _atom.Disposable(function () {
      sidebar.destroyView('nuclide-file-tree');
    });

    return sideBarDisposable;
  },

  consumeWorkingSetsStore: function consumeWorkingSetsStore(workingSetsStore) {
    (0, _assert2['default'])(activation);

    return activation.consumeWorkingSetsStore(workingSetsStore);
  }
};
//# sourceMappingURL=data:application/json;base64,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QUcsSUFBSSxDQUFDO0tBQ25CO0dBQ0Y7O0FBRUQsV0FBUyxFQUFBLHFCQUE2QjtBQUNwQyxRQUFJLFVBQVUsRUFBRTtBQUNkLGFBQU8sVUFBVSxDQUFDLFNBQVMsRUFBRSxDQUFDO0tBQy9CO0dBQ0Y7O0FBRUQsdUJBQXFCLEVBQUEsK0JBQUMsT0FBOEIsRUFBZTtBQUNqRSw2QkFBVSxVQUFVLENBQUMsQ0FBQzs7QUFFdEIsV0FBTyxDQUFDLFlBQVksQ0FBQztBQUNuQixrQkFBWSxFQUFBLHdCQUFHO0FBQUUsZUFBTyxPQUFPLENBQUMsd0NBQXdDLENBQUMsQ0FBQztPQUFFO0FBQzVFLGVBQVMsRUFBQSxxQkFBRzs7O0FBR1YsWUFBSSwyQkFBYyxHQUFHLENBQUMsNkJBQTZCLENBQUMsRUFBRTtBQUNwRCxjQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FDcEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUNsQyxzQ0FBc0MsQ0FDdkMsQ0FBQztTQUNIO09BQ0Y7QUFDRCxtQkFBYSxFQUFFLDBCQUEwQjtBQUN6QyxZQUFNLEVBQUUsbUJBQW1CO0tBQzVCLENBQUMsQ0FBQzs7QUFFSCxxQkFBaUIsR0FBRyxxQkFBZSxZQUFNO0FBQ3ZDLGFBQU8sQ0FBQyxXQUFXLENBQUMsbUJBQW1CLENBQUMsQ0FBQztLQUMxQyxDQUFDLENBQUM7O0FBRUgsV0FBTyxpQkFBaUIsQ0FBQztHQUMxQjs7QUFFRCx5QkFBdUIsRUFBQSxpQ0FBQyxnQkFBa0MsRUFBZ0I7QUFDeEUsNkJBQVUsVUFBVSxDQUFDLENBQUM7O0FBRXRCLFdBQU8sVUFBVSxDQUFDLHVCQUF1QixDQUFDLGdCQUFnQixDQUFDLENBQUM7R0FDN0Q7Q0FDRixDQUFDIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7RmlsZVRyZWVDb250cm9sbGVyU3RhdGV9IGZyb20gJy4vRmlsZVRyZWVDb250cm9sbGVyJztcbmltcG9ydCB0eXBlIEZpbGVUcmVlQ29udHJvbGxlclR5cGUgZnJvbSAnLi9GaWxlVHJlZUNvbnRyb2xsZXInO1xuaW1wb3J0IHR5cGUge051Y2xpZGVTaWRlQmFyU2VydmljZX0gZnJvbSAnLi4vLi4vc2lkZS1iYXInO1xuXG5pbXBvcnQge0Rpc3Bvc2FibGUsIENvbXBvc2l0ZURpc3Bvc2FibGV9IGZyb20gJ2F0b20nO1xuaW1wb3J0IGludmFyaWFudCBmcm9tICdhc3NlcnQnO1xuXG5pbXBvcnQgZmVhdHVyZUNvbmZpZyBmcm9tICcuLi8uLi9mZWF0dXJlLWNvbmZpZyc7XG5cbmltcG9ydCB7V29ya2luZ1NldH0gZnJvbSAnLi4vLi4vd29ya2luZy1zZXRzJztcbmltcG9ydCB0eXBlIHtXb3JraW5nU2V0c1N0b3JlfSBmcm9tICcuLi8uLi93b3JraW5nLXNldHMvbGliL1dvcmtpbmdTZXRzU3RvcmUnO1xuXG4vKipcbiAqIE1pbmltdW0gaW50ZXJ2YWwgKGluIG1zKSBiZXR3ZWVuIG9uQ2hhbmdlQWN0aXZlUGFuZUl0ZW0gZXZlbnRzIGJlZm9yZSByZXZlYWxpbmcgdGhlIGFjdGl2ZSBwYW5lXG4gKiBpdGVtIGluIHRoZSBmaWxlIHRyZWUuXG4gKi9cbmNvbnN0IEFDVElWRV9QQU5FX0RFQk9VTkNFX0lOVEVSVkFMX01TID0gMTUwO1xuXG5jb25zdCBSRVZFQUxfRklMRV9PTl9TV0lUQ0hfU0VUVElORyA9ICdudWNsaWRlLWZpbGUtdHJlZS5yZXZlYWxGaWxlT25Td2l0Y2gnO1xuXG5jbGFzcyBBY3RpdmF0aW9uIHtcbiAgX2ZpbGVUcmVlQ29udHJvbGxlcjogRmlsZVRyZWVDb250cm9sbGVyVHlwZTtcbiAgX3BhY2thZ2VTdGF0ZTogP0ZpbGVUcmVlQ29udHJvbGxlclN0YXRlO1xuICBfc3Vic2NyaXB0aW9uczogQ29tcG9zaXRlRGlzcG9zYWJsZTtcbiAgX3BhbmVJdGVtU3Vic2NyaXB0aW9uOiA/RGlzcG9zYWJsZTtcblxuICBjb25zdHJ1Y3RvcihzdGF0ZTogP0ZpbGVUcmVlQ29udHJvbGxlclN0YXRlKSB7XG4gICAgdGhpcy5fcGFja2FnZVN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5cbiAgICBjb25zdCBGaWxlVHJlZUNvbnRyb2xsZXIgPSByZXF1aXJlKCcuL0ZpbGVUcmVlQ29udHJvbGxlcicpO1xuICAgIHRoaXMuX2ZpbGVUcmVlQ29udHJvbGxlciA9IG5ldyBGaWxlVHJlZUNvbnRyb2xsZXIodGhpcy5fcGFja2FnZVN0YXRlKTtcblxuICAgIGNvbnN0IGV4Y2x1ZGVWY3NJZ25vcmVkUGF0aHNTZXR0aW5nID0gJ2NvcmUuZXhjbHVkZVZjc0lnbm9yZWRQYXRocyc7XG4gICAgY29uc3QgaGlkZUlnbm9yZWROYW1lc1NldHRpbmcgPSAnbnVjbGlkZS1maWxlLXRyZWUuaGlkZUlnbm9yZWROYW1lcyc7XG4gICAgY29uc3QgaWdub3JlZE5hbWVzU2V0dGluZyA9ICdjb3JlLmlnbm9yZWROYW1lcyc7XG4gICAgY29uc3QgcHJlZml4S2V5TmF2U2V0dGluZyA9ICdudWNsaWRlLWZpbGUtdHJlZS5hbGxvd0tleWJvYXJkUHJlZml4TmF2aWdhdGlvbic7XG4gICAgY29uc3QgdXNlUHJldmlld1RhYnMgPSAndGFicy51c2VQcmV2aWV3VGFicyc7XG5cbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIGZlYXR1cmVDb25maWcub2JzZXJ2ZShwcmVmaXhLZXlOYXZTZXR0aW5nLCB0aGlzLl9zZXRQcmVmaXhLZXlOYXZTZXR0aW5nLmJpbmQodGhpcykpLFxuICAgICAgZmVhdHVyZUNvbmZpZy5vYnNlcnZlKFJFVkVBTF9GSUxFX09OX1NXSVRDSF9TRVRUSU5HLCB0aGlzLl9zZXRSZXZlYWxPbkZpbGVTd2l0Y2guYmluZCh0aGlzKSksXG4gICAgICBhdG9tLmNvbmZpZy5vYnNlcnZlKGlnbm9yZWROYW1lc1NldHRpbmcsIHRoaXMuX3NldElnbm9yZWROYW1lcy5iaW5kKHRoaXMpKSxcbiAgICAgIGZlYXR1cmVDb25maWcub2JzZXJ2ZShoaWRlSWdub3JlZE5hbWVzU2V0dGluZywgdGhpcy5fc2V0SGlkZUlnbm9yZWROYW1lcy5iaW5kKHRoaXMpKSxcbiAgICAgIGF0b20uY29uZmlnLm9ic2VydmUoXG4gICAgICAgIGV4Y2x1ZGVWY3NJZ25vcmVkUGF0aHNTZXR0aW5nLFxuICAgICAgICB0aGlzLl9zZXRFeGNsdWRlVmNzSWdub3JlZFBhdGhzLmJpbmQodGhpcyksXG4gICAgICApLFxuICAgICAgYXRvbS5jb25maWcub2JzZXJ2ZSh1c2VQcmV2aWV3VGFicywgdGhpcy5fc2V0VXNlUHJldmlld1RhYnMuYmluZCh0aGlzKSksXG4gICAgKTtcblxuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICB0aGlzLl9kZWFjdGl2YXRlKCk7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5kaXNwb3NlKCk7XG4gIH1cblxuICBzZXJpYWxpemUoKTogP0ZpbGVUcmVlQ29udHJvbGxlclN0YXRlIHtcbiAgICByZXR1cm4gdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyLnNlcmlhbGl6ZSgpO1xuICB9XG5cbiAgY29uc3VtZVdvcmtpbmdTZXRzU3RvcmUod29ya2luZ1NldHNTdG9yZTogV29ya2luZ1NldHNTdG9yZSk6ID9JRGlzcG9zYWJsZSB7XG4gICAgdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyLnVwZGF0ZVdvcmtpbmdTZXRzU3RvcmUod29ya2luZ1NldHNTdG9yZSk7XG4gICAgdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyLnVwZGF0ZVdvcmtpbmdTZXQod29ya2luZ1NldHNTdG9yZS5nZXRDdXJyZW50KCkpO1xuXG4gICAgY29uc3QgY3VycmVudFN1YnNjcmlwdGlvbiA9IHdvcmtpbmdTZXRzU3RvcmUuc3Vic2NyaWJlVG9DdXJyZW50KGN1cnJlbnRXb3JraW5nU2V0ID0+IHtcbiAgICAgIHRoaXMuX2ZpbGVUcmVlQ29udHJvbGxlci51cGRhdGVXb3JraW5nU2V0KGN1cnJlbnRXb3JraW5nU2V0KTtcbiAgICB9KTtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmFkZChjdXJyZW50U3Vic2NyaXB0aW9uKTtcblxuICAgIGNvbnN0IHJlYnVpbGRPcGVuRmlsZXNXb3JraW5nU2V0ID0gKCkgPT4ge1xuICAgICAgY29uc3Qgb3BlblVyaXMgPSBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpXG4gICAgICAgIC5maWx0ZXIodGUgPT4gdGUuZ2V0UGF0aCgpICE9IG51bGwgJiYgdGUuZ2V0UGF0aCgpICE9PSAnJylcbiAgICAgICAgLm1hcCh0ZSA9PiAodGUuZ2V0UGF0aCgpOiBhbnkpKTtcbiAgICAgIGNvbnN0IG9wZW5GaWxlc1dvcmtpbmdTZXQgPSBuZXcgV29ya2luZ1NldChvcGVuVXJpcyk7XG4gICAgICB0aGlzLl9maWxlVHJlZUNvbnRyb2xsZXIudXBkYXRlT3BlbkZpbGVzV29ya2luZ1NldChvcGVuRmlsZXNXb3JraW5nU2V0KTtcbiAgICB9O1xuXG4gICAgcmVidWlsZE9wZW5GaWxlc1dvcmtpbmdTZXQoKTtcblxuICAgIGNvbnN0IHBhbmVPYnNlcnZpbmdEaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICBwYW5lT2JzZXJ2aW5nRGlzcG9zYWJsZS5hZGQoYXRvbS53b3Jrc3BhY2Uub25EaWRBZGRQYW5lSXRlbShyZWJ1aWxkT3BlbkZpbGVzV29ya2luZ1NldCkpO1xuICAgIHBhbmVPYnNlcnZpbmdEaXNwb3NhYmxlLmFkZChhdG9tLndvcmtzcGFjZS5vbkRpZERlc3Ryb3lQYW5lSXRlbShyZWJ1aWxkT3BlbkZpbGVzV29ya2luZ1NldCkpO1xuXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5hZGQocGFuZU9ic2VydmluZ0Rpc3Bvc2FibGUpO1xuXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuX2ZpbGVUcmVlQ29udHJvbGxlci51cGRhdGVXb3JraW5nU2V0c1N0b3JlKG51bGwpO1xuICAgICAgdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyLnVwZGF0ZVdvcmtpbmdTZXQobmV3IFdvcmtpbmdTZXQoKSk7XG4gICAgICB0aGlzLl9maWxlVHJlZUNvbnRyb2xsZXIudXBkYXRlT3BlbkZpbGVzV29ya2luZ1NldChuZXcgV29ya2luZ1NldCgpKTtcbiAgICAgIHBhbmVPYnNlcnZpbmdEaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucmVtb3ZlKGN1cnJlbnRTdWJzY3JpcHRpb24pO1xuICAgICAgY3VycmVudFN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7XG4gICAgfSk7XG4gIH1cblxuICBfc2V0RXhjbHVkZVZjc0lnbm9yZWRQYXRocyhleGNsdWRlVmNzSWdub3JlZFBhdGhzOiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyLnNldEV4Y2x1ZGVWY3NJZ25vcmVkUGF0aHMoZXhjbHVkZVZjc0lnbm9yZWRQYXRocyk7XG4gIH1cblxuICBfc2V0SGlkZUlnbm9yZWROYW1lcyhoaWRlSWdub3JlZE5hbWVzOiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyLnNldEhpZGVJZ25vcmVkTmFtZXMoaGlkZUlnbm9yZWROYW1lcyk7XG4gIH1cblxuICBfc2V0SWdub3JlZE5hbWVzKGlnbm9yZWROYW1lczogc3RyaW5nfEFycmF5PHN0cmluZz4pIHtcbiAgICBsZXQgbm9ybWFsaXplZElnbm9yZWROYW1lcztcbiAgICBpZiAoaWdub3JlZE5hbWVzID09PSAnJykge1xuICAgICAgbm9ybWFsaXplZElnbm9yZWROYW1lcyA9IFtdO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGlnbm9yZWROYW1lcyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIG5vcm1hbGl6ZWRJZ25vcmVkTmFtZXMgPSBbaWdub3JlZE5hbWVzXTtcbiAgICB9IGVsc2Uge1xuICAgICAgbm9ybWFsaXplZElnbm9yZWROYW1lcyA9IGlnbm9yZWROYW1lcztcbiAgICB9XG4gICAgdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyLnNldElnbm9yZWROYW1lcyhub3JtYWxpemVkSWdub3JlZE5hbWVzKTtcbiAgfVxuXG4gIF9zZXRSZXZlYWxPbkZpbGVTd2l0Y2goc2hvdWxkUmV2ZWFsOiBib29sZWFuKSB7XG4gICAgY29uc3Qge29uV29ya3NwYWNlRGlkU3RvcENoYW5naW5nQWN0aXZlUGFuZUl0ZW19ID1cbiAgICAgIHJlcXVpcmUoJy4uLy4uL2F0b20taGVscGVycycpLmF0b21FdmVudERlYm91bmNlO1xuXG4gICAgaWYgKHNob3VsZFJldmVhbCkge1xuICAgICAgY29uc3QgcmV2ZWFsID0gKCkgPT4ge1xuICAgICAgICB0aGlzLl9maWxlVHJlZUNvbnRyb2xsZXIucmV2ZWFsQWN0aXZlRmlsZSgvKiBzaG93SWZIaWRkZW4gKi8gZmFsc2UpO1xuICAgICAgfTtcbiAgICAgIC8vIEd1YXJkIGFnYWluc3QgdGhpcyBnZXR0aW5nIGNhbGxlZCBtdWx0aXBsZSB0aW1lc1xuICAgICAgaWYgKCF0aGlzLl9wYW5lSXRlbVN1YnNjcmlwdGlvbikge1xuICAgICAgICAvLyBEZWJvdW5jZSB0YWIgY2hhbmdlIGV2ZW50cyB0byBsaW1pdCB1bm5lZWRlZCBzY3JvbGxpbmcgd2hlbiBjaGFuZ2luZyBvciBjbG9zaW5nIHRhYnNcbiAgICAgICAgLy8gaW4gcXVpY2sgc3VjY2Vzc2lvbi5cbiAgICAgICAgdGhpcy5fcGFuZUl0ZW1TdWJzY3JpcHRpb24gPSBvbldvcmtzcGFjZURpZFN0b3BDaGFuZ2luZ0FjdGl2ZVBhbmVJdGVtKFxuICAgICAgICAgIHJldmVhbCxcbiAgICAgICAgICBBQ1RJVkVfUEFORV9ERUJPVU5DRV9JTlRFUlZBTF9NU1xuICAgICAgICApO1xuICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmFkZCh0aGlzLl9wYW5lSXRlbVN1YnNjcmlwdGlvbik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFVzZSBhIGxvY2FsIHNvIEZsb3cgY2FuIHJlZmluZSB0aGUgdHlwZS5cbiAgICAgIGNvbnN0IHBhbmVJdGVtU3Vic2NyaXB0aW9uID0gdGhpcy5fcGFuZUl0ZW1TdWJzY3JpcHRpb247XG4gICAgICBpZiAocGFuZUl0ZW1TdWJzY3JpcHRpb24pIHtcbiAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5yZW1vdmUocGFuZUl0ZW1TdWJzY3JpcHRpb24pO1xuICAgICAgICBwYW5lSXRlbVN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7XG4gICAgICAgIHRoaXMuX3BhbmVJdGVtU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBfc2V0UHJlZml4S2V5TmF2U2V0dGluZyh1c2VQcmVmaXhOYXY6ID9ib29sZWFuKTogdm9pZCB7XG4gICAgLy8gY29uZmlnIGlzIHZvaWQgZHVyaW5nIHN0YXJ0dXAsIHNpZ25pZnlpbmcgbm8gY29uZmlnIHlldFxuICAgIGlmICh1c2VQcmVmaXhOYXYgPT0gbnVsbCB8fCAhdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2ZpbGVUcmVlQ29udHJvbGxlci5zZXRVc2VQcmVmaXhOYXYodXNlUHJlZml4TmF2KTtcbiAgfVxuXG4gIF9zZXRVc2VQcmV2aWV3VGFicyh1c2VQcmV2aWV3VGFiczogP2Jvb2xlYW4pOiB2b2lkIHtcbiAgICAvLyBjb25maWcgaXMgdm9pZCBkdXJpbmcgc3RhcnR1cCwgc2lnbmlmeWluZyBubyBjb25maWcgeWV0XG4gICAgaWYgKHVzZVByZXZpZXdUYWJzID09IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fZmlsZVRyZWVDb250cm9sbGVyLnNldFVzZVByZXZpZXdUYWJzKHVzZVByZXZpZXdUYWJzKTtcbiAgfVxuXG4gIF9kZWFjdGl2YXRlKCkge1xuICAgIC8vIEd1YXJkIGFnYWluc3QgZGVhY3RpdmF0ZSBiZWluZyBjYWxsZWQgdHdpY2VcbiAgICB0aGlzLl9maWxlVHJlZUNvbnRyb2xsZXIuZGVzdHJveSgpO1xuICB9XG59XG5cbmxldCBhY3RpdmF0aW9uOiA/QWN0aXZhdGlvbjtcbmxldCBkZXNlcmlhbGl6ZWRTdGF0ZTogP0ZpbGVUcmVlQ29udHJvbGxlclN0YXRlO1xubGV0IG9uRGlkQWN0aXZhdGVEaXNwb3NhYmxlOiBJRGlzcG9zYWJsZTtcbmxldCBzaWRlQmFyRGlzcG9zYWJsZTogP0lEaXNwb3NhYmxlO1xuXG5mdW5jdGlvbiBkaXNhYmxlVHJlZVZpZXdQYWNrYWdlKCkge1xuICBpZiAoIWF0b20ucGFja2FnZXMuaXNQYWNrYWdlRGlzYWJsZWQoJ3RyZWUtdmlldycpKSB7XG4gICAgLy8gQ2FsbGluZyBgZGlzYWJsZVBhY2thZ2VgIG9uIGEgcGFja2FnZSBmaXJzdCAqbG9hZHMqIHRoZSBwYWNrYWdlLiBUaGlzIHN0ZXAgbXVzdCBjb21lXG4gICAgLy8gYmVmb3JlIGNhbGxpbmcgYHVubG9hZFBhY2thZ2VgLlxuICAgIGF0b20ucGFja2FnZXMuZGlzYWJsZVBhY2thZ2UoJ3RyZWUtdmlldycpO1xuICB9XG5cbiAgaWYgKGF0b20ucGFja2FnZXMuaXNQYWNrYWdlQWN0aXZlKCd0cmVlLXZpZXcnKSkge1xuICAgIC8vIE9ubHkgKmluYWN0aXZlKiBwYWNrYWdlcyBjYW4gYmUgdW5sb2FkZWQuIEF0dGVtcHRpbmcgdG8gdW5sb2FkIGFuIGFjdGl2ZSBwYWNrYWdlIGlzXG4gICAgLy8gY29uc2lkZXJlZCBhbiBleGNlcHRpb24uIERlYWN0aXZhdGluZyBtdXN0IGNvbWUgYmVmb3JlIHVubG9hZGluZy5cbiAgICBhdG9tLnBhY2thZ2VzLmRlYWN0aXZhdGVQYWNrYWdlKCd0cmVlLXZpZXcnKTtcbiAgfVxuXG4gIGlmIChhdG9tLnBhY2thZ2VzLmlzUGFja2FnZUxvYWRlZCgndHJlZS12aWV3JykpIHtcbiAgICBhdG9tLnBhY2thZ2VzLnVubG9hZFBhY2thZ2UoJ3RyZWUtdmlldycpO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBhY3RpdmF0ZShzdGF0ZTogP0ZpbGVUcmVlQ29udHJvbGxlclN0YXRlKTogdm9pZCB7XG4gICAgaW52YXJpYW50KGFjdGl2YXRpb24gPT0gbnVsbCk7XG4gICAgLy8gRGlzYWJsZSBBdG9tJ3MgYnVuZGxlZCAndHJlZS12aWV3JyBwYWNrYWdlLiBJZiB0aGlzIGFjdGl2YXRpb24gaXMgaGFwcGVuaW5nIGR1cmluZyB0aGVcbiAgICAvLyBub3JtYWwgc3RhcnR1cCBhY3RpdmF0aW9uLCB0aGUgYG9uRGlkQWN0aXZhdGVJbml0aWFsUGFja2FnZXNgIGhhbmRsZXIgYmVsb3cgbXVzdCB1bmxvYWQgdGhlXG4gICAgLy8gJ3RyZWUtdmlldycgYmVjYXVzZSBpdCB3aWxsIGhhdmUgYmVlbiBsb2FkZWQgZHVyaW5nIHN0YXJ0dXAuXG4gICAgZGlzYWJsZVRyZWVWaWV3UGFja2FnZSgpO1xuXG4gICAgLy8gRGlzYWJsaW5nIGFuZCB1bmxvYWRpbmcgQXRvbSdzIGJ1bmRsZWQgJ3RyZWUtdmlldycgbXVzdCBoYXBwZW4gYWZ0ZXIgYWN0aXZhdGlvbiBiZWNhdXNlIHRoaXNcbiAgICAvLyBwYWNrYWdlJ3MgYGFjdGl2YXRlYCBpcyBjYWxsZWQgZHVyaW5nIGFuIHRyYXZlcnNhbCBvZiBhbGwgaW5pdGlhbCBwYWNrYWdlcyB0byBhY3RpdmF0ZS5cbiAgICAvLyBEaXNhYmxpbmcgYSBwYWNrYWdlIGR1cmluZyB0aGUgdHJhdmVyc2FsIGhhcyBubyBlZmZlY3QgaWYgdGhpcyBpcyBhIHN0YXJ0dXAgbG9hZCBiZWNhdXNlXG4gICAgLy8gYFBhY2thZ2VNYW5hZ2VyYCBkb2VzIG5vdCByZS1sb2FkIHRoZSBsaXN0IG9mIHBhY2thZ2VzIHRvIGFjdGl2YXRlIGFmdGVyIGVhY2ggaXRlcmF0aW9uLlxuICAgIG9uRGlkQWN0aXZhdGVEaXNwb3NhYmxlID0gYXRvbS5wYWNrYWdlcy5vbkRpZEFjdGl2YXRlSW5pdGlhbFBhY2thZ2VzKCgpID0+IHtcbiAgICAgIGRpc2FibGVUcmVlVmlld1BhY2thZ2UoKTtcbiAgICAgIG9uRGlkQWN0aXZhdGVEaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICB9KTtcblxuICAgIGRlc2VyaWFsaXplZFN0YXRlID0gc3RhdGU7XG4gICAgYWN0aXZhdGlvbiA9IG5ldyBBY3RpdmF0aW9uKGRlc2VyaWFsaXplZFN0YXRlKTtcbiAgfSxcblxuICBkZWFjdGl2YXRlKCkge1xuICAgIGNvbnN0IG51Y2xpZGVGZWF0dXJlcyA9IHJlcXVpcmUoJy4uLy4uLy4uLy4uL2xpYi9udWNsaWRlRmVhdHVyZXMnKTtcblxuICAgIC8vIFJlLWVuYWJsZSBBdG9tJ3MgYnVuZGxlZCAndHJlZS12aWV3JyB3aGVuIHRoaXMgcGFja2FnZSBpcyBkaXNhYmxlZCB0byBsZWF2ZSB0aGUgdXNlcidzXG4gICAgLy8gZW52aXJvbm1lbnQgdGhlIHdheSB0aGlzIHBhY2thZ2UgZm91bmQgaXQuXG4gICAgaWYgKG51Y2xpZGVGZWF0dXJlcy5pc0ZlYXR1cmVEaXNhYmxlZCgnbnVjbGlkZS1maWxlLXRyZWUnKVxuICAgICAgJiYgYXRvbS5wYWNrYWdlcy5pc1BhY2thZ2VEaXNhYmxlZCgndHJlZS12aWV3JykpIHtcbiAgICAgIGF0b20ucGFja2FnZXMuZW5hYmxlUGFja2FnZSgndHJlZS12aWV3Jyk7XG4gICAgfVxuXG4gICAgaWYgKHNpZGVCYXJEaXNwb3NhYmxlICE9IG51bGwpIHtcbiAgICAgIHNpZGVCYXJEaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICB9XG5cbiAgICBpZiAoIW9uRGlkQWN0aXZhdGVEaXNwb3NhYmxlLmRpc3Bvc2VkKSB7XG4gICAgICBvbkRpZEFjdGl2YXRlRGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gICAgfVxuXG4gICAgaWYgKGFjdGl2YXRpb24pIHtcbiAgICAgIGFjdGl2YXRpb24uZGlzcG9zZSgpO1xuICAgICAgYWN0aXZhdGlvbiA9IG51bGw7XG4gICAgfVxuICB9LFxuXG4gIHNlcmlhbGl6ZSgpOiA/RmlsZVRyZWVDb250cm9sbGVyU3RhdGUge1xuICAgIGlmIChhY3RpdmF0aW9uKSB7XG4gICAgICByZXR1cm4gYWN0aXZhdGlvbi5zZXJpYWxpemUoKTtcbiAgICB9XG4gIH0sXG5cbiAgY29uc3VtZU51Y2xpZGVTaWRlQmFyKHNpZGViYXI6IE51Y2xpZGVTaWRlQmFyU2VydmljZSk6IElEaXNwb3NhYmxlIHtcbiAgICBpbnZhcmlhbnQoYWN0aXZhdGlvbik7XG5cbiAgICBzaWRlYmFyLnJlZ2lzdGVyVmlldyh7XG4gICAgICBnZXRDb21wb25lbnQoKSB7IHJldHVybiByZXF1aXJlKCcuLi9jb21wb25lbnRzL0ZpbGVUcmVlU2lkZWJhckNvbXBvbmVudCcpOyB9LFxuICAgICAgb25EaWRTaG93KCkge1xuICAgICAgICAvLyBJZiBcIlJldmVhbCBGaWxlIG9uIFN3aXRjaFwiIGlzIGVuYWJsZWQsIGVuc3VyZSB0aGUgc2Nyb2xsIHBvc2l0aW9uIGlzIHN5bmNlZCB0byB3aGVyZSB0aGVcbiAgICAgICAgLy8gdXNlciBleHBlY3RzIHdoZW4gdGhlIHNpZGUgYmFyIHNob3dzIHRoZSBmaWxlIHRyZWUuXG4gICAgICAgIGlmIChmZWF0dXJlQ29uZmlnLmdldChSRVZFQUxfRklMRV9PTl9TV0lUQ0hfU0VUVElORykpIHtcbiAgICAgICAgICBhdG9tLmNvbW1hbmRzLmRpc3BhdGNoKFxuICAgICAgICAgICAgYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlKSxcbiAgICAgICAgICAgICdudWNsaWRlLWZpbGUtdHJlZTpyZXZlYWwtYWN0aXZlLWZpbGUnXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHRvZ2dsZUNvbW1hbmQ6ICdudWNsaWRlLWZpbGUtdHJlZTp0b2dnbGUnLFxuICAgICAgdmlld0lkOiAnbnVjbGlkZS1maWxlLXRyZWUnLFxuICAgIH0pO1xuXG4gICAgc2lkZUJhckRpc3Bvc2FibGUgPSBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICBzaWRlYmFyLmRlc3Ryb3lWaWV3KCdudWNsaWRlLWZpbGUtdHJlZScpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHNpZGVCYXJEaXNwb3NhYmxlO1xuICB9LFxuXG4gIGNvbnN1bWVXb3JraW5nU2V0c1N0b3JlKHdvcmtpbmdTZXRzU3RvcmU6IFdvcmtpbmdTZXRzU3RvcmUpOiA/SURpc3Bvc2FibGUge1xuICAgIGludmFyaWFudChhY3RpdmF0aW9uKTtcblxuICAgIHJldHVybiBhY3RpdmF0aW9uLmNvbnN1bWVXb3JraW5nU2V0c1N0b3JlKHdvcmtpbmdTZXRzU3RvcmUpO1xuICB9LFxufTtcbiJdfQ==