function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _atom = require('atom');

var _nuclideFeatureConfig = require('../../nuclide-feature-config');

var _nuclideFeatureConfig2 = _interopRequireDefault(_nuclideFeatureConfig);

var _nuclideCommons = require('../../nuclide-commons');

var observableFromSubscribeFunction = _nuclideCommons.event.observableFromSubscribeFunction;

var legacyLinterSetting = 'nuclide-diagnostics-store.consumeLegacyLinters';

var legacyLintOnTheFlySetting = 'nuclide-diagnostics-store.legacyLintOnTheFly';

var disposables = null;
var diagnosticStore = null;
var diagnosticUpdater = null;

function addDisposable(disposable) {
  if (disposables) {
    disposables.add(disposable);
  } else {
    var logger = require('../../nuclide-logging').getLogger();
    logger.error('disposables is null');
  }
}

function getDiagnosticStore() {
  if (!diagnosticStore) {
    diagnosticStore = new (require('../../nuclide-diagnostics-base').DiagnosticStore)();
  }
  return diagnosticStore;
}

/**
 * @return A wrapper around the methods on DiagnosticStore that allow reading data.
 */
function getDiagnosticUpdater() {
  if (!diagnosticUpdater) {
    var store = getDiagnosticStore();
    diagnosticUpdater = {
      onFileMessagesDidUpdate: store.onFileMessagesDidUpdate.bind(store),
      onProjectMessagesDidUpdate: store.onProjectMessagesDidUpdate.bind(store),
      onAllMessagesDidUpdate: store.onAllMessagesDidUpdate.bind(store),
      applyFix: store.applyFix.bind(store),
      applyFixesForFile: store.applyFixesForFile.bind(store)
    };
  }
  return diagnosticUpdater;
}

var consumeLegacyLinters = false;
var lintOnTheFly = false;
var allLinterAdapters = new Set();

module.exports = {
  activate: function activate(state) {
    if (!disposables) {
      disposables = new _atom.CompositeDisposable();
    }

    // Returns mixed so a cast is necessary.
    consumeLegacyLinters = _nuclideFeatureConfig2['default'].get(legacyLinterSetting);
    _nuclideFeatureConfig2['default'].observe(legacyLinterSetting, function (newValue) {
      // To make this really solid, we should also probably trigger the linter
      // for the active text editor. Possibly more trouble than it's worth,
      // though, since this may be a temporary option.
      consumeLegacyLinters = newValue;
      allLinterAdapters.forEach(function (adapter) {
        return adapter.setEnabled(newValue);
      });
    });

    lintOnTheFly = _nuclideFeatureConfig2['default'].get(legacyLintOnTheFlySetting);
    _nuclideFeatureConfig2['default'].observe(legacyLintOnTheFlySetting, function (newValue) {
      lintOnTheFly = newValue;
      allLinterAdapters.forEach(function (adapter) {
        return adapter.setLintOnFly(newValue);
      });
    });
  },

  consumeLinterProvider: function consumeLinterProvider(provider) {
    var _this = this;

    var _require = require('./LinterAdapterFactory');

    var createAdapters = _require.createAdapters;

    var newAdapters = createAdapters(provider);
    var adapterDisposables = new _atom.CompositeDisposable();

    var _loop = function (adapter) {
      adapter.setEnabled(consumeLegacyLinters);
      adapter.setLintOnFly(lintOnTheFly);
      allLinterAdapters.add(adapter);
      var diagnosticDisposable = _this.consumeDiagnosticsProviderV1(adapter);
      var adapterDisposable = new _atom.Disposable(function () {
        diagnosticDisposable.dispose();
        adapter.dispose();
        allLinterAdapters['delete'](adapter);
      });
      adapterDisposables.add(adapterDisposable);
      addDisposable(adapter);
    };

    for (var adapter of newAdapters) {
      _loop(adapter);
    }
    return adapterDisposables;
  },

  consumeDiagnosticsProviderV1: function consumeDiagnosticsProviderV1(provider) {
    // Register the diagnostic store for updates from the new provider.
    var observableProvider = {
      updates: observableFromSubscribeFunction(provider.onMessageUpdate.bind(provider)),
      invalidations: observableFromSubscribeFunction(provider.onMessageInvalidation.bind(provider))
    };
    var disposable = this.consumeDiagnosticsProviderV2(observableProvider);
    addDisposable(disposable);
    return disposable;
  },

  consumeDiagnosticsProviderV2: function consumeDiagnosticsProviderV2(provider) {
    var compositeDisposable = new _atom.CompositeDisposable();
    var store = getDiagnosticStore();

    compositeDisposable.add(provider.updates.subscribe(function (update) {
      return store.updateMessages(provider, update);
    }));
    compositeDisposable.add(provider.invalidations.subscribe(function (invalidation) {
      return store.invalidateMessages(provider, invalidation);
    }));
    compositeDisposable.add(new _atom.Disposable(function () {
      store.invalidateMessages(provider, { scope: 'all' });
    }));

    return compositeDisposable;
  },

  provideDiagnosticUpdates: function provideDiagnosticUpdates() {
    return getDiagnosticUpdater();
  },

  deactivate: function deactivate() {
    if (disposables) {
      disposables.dispose();
      disposables = null;
    }
    if (diagnosticStore) {
      diagnosticStore.dispose();
      diagnosticStore = null;
    }
    diagnosticUpdater = null;
  }
};
//# sourceMappingURL=data:application/json;base64,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QU8sRUFBRSxDQUFDO0FBQzFCLHFCQUFlLEdBQUcsSUFBSSxDQUFDO0tBQ3hCO0FBQ0QscUJBQWlCLEdBQUcsSUFBSSxDQUFDO0dBQzFCO0NBQ0YsQ0FBQyIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuaW1wb3J0IHR5cGUge1xuICBEaWFnbm9zdGljU3RvcmUsXG4gIERpYWdub3N0aWNVcGRhdGVyLFxuICBDYWxsYmFja0RpYWdub3N0aWNQcm92aWRlcixcbiAgTGludGVyUHJvdmlkZXIsXG4gIE9ic2VydmFibGVEaWFnbm9zdGljUHJvdmlkZXIsXG59IGZyb20gJy4uLy4uL251Y2xpZGUtZGlhZ25vc3RpY3MtYmFzZSc7XG5cbmltcG9ydCB7RGlzcG9zYWJsZSwgQ29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XG5pbXBvcnQgZmVhdHVyZUNvbmZpZyBmcm9tICcuLi8uLi9udWNsaWRlLWZlYXR1cmUtY29uZmlnJztcbmltcG9ydCB7ZXZlbnR9IGZyb20gJy4uLy4uL251Y2xpZGUtY29tbW9ucyc7XG5cbmNvbnN0IHtvYnNlcnZhYmxlRnJvbVN1YnNjcmliZUZ1bmN0aW9ufSA9IGV2ZW50O1xuXG5jb25zdCBsZWdhY3lMaW50ZXJTZXR0aW5nID0gJ251Y2xpZGUtZGlhZ25vc3RpY3Mtc3RvcmUuY29uc3VtZUxlZ2FjeUxpbnRlcnMnO1xuXG5jb25zdCBsZWdhY3lMaW50T25UaGVGbHlTZXR0aW5nID0gJ251Y2xpZGUtZGlhZ25vc3RpY3Mtc3RvcmUubGVnYWN5TGludE9uVGhlRmx5JztcblxubGV0IGRpc3Bvc2FibGVzID0gbnVsbDtcbmxldCBkaWFnbm9zdGljU3RvcmUgPSBudWxsO1xubGV0IGRpYWdub3N0aWNVcGRhdGVyID0gbnVsbDtcblxuZnVuY3Rpb24gYWRkRGlzcG9zYWJsZShkaXNwb3NhYmxlOiBJRGlzcG9zYWJsZSkge1xuICBpZiAoZGlzcG9zYWJsZXMpIHtcbiAgICBkaXNwb3NhYmxlcy5hZGQoZGlzcG9zYWJsZSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnLi4vLi4vbnVjbGlkZS1sb2dnaW5nJykuZ2V0TG9nZ2VyKCk7XG4gICAgbG9nZ2VyLmVycm9yKCdkaXNwb3NhYmxlcyBpcyBudWxsJyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RGlhZ25vc3RpY1N0b3JlKCk6IERpYWdub3N0aWNTdG9yZSB7XG4gIGlmICghZGlhZ25vc3RpY1N0b3JlKSB7XG4gICAgZGlhZ25vc3RpY1N0b3JlID0gbmV3IChyZXF1aXJlKCcuLi8uLi9udWNsaWRlLWRpYWdub3N0aWNzLWJhc2UnKS5EaWFnbm9zdGljU3RvcmUpKCk7XG4gIH1cbiAgcmV0dXJuIGRpYWdub3N0aWNTdG9yZTtcbn1cblxuLyoqXG4gKiBAcmV0dXJuIEEgd3JhcHBlciBhcm91bmQgdGhlIG1ldGhvZHMgb24gRGlhZ25vc3RpY1N0b3JlIHRoYXQgYWxsb3cgcmVhZGluZyBkYXRhLlxuICovXG5mdW5jdGlvbiBnZXREaWFnbm9zdGljVXBkYXRlcigpOiBEaWFnbm9zdGljVXBkYXRlciB7XG4gIGlmICghZGlhZ25vc3RpY1VwZGF0ZXIpIHtcbiAgICBjb25zdCBzdG9yZSA9IGdldERpYWdub3N0aWNTdG9yZSgpO1xuICAgIGRpYWdub3N0aWNVcGRhdGVyID0ge1xuICAgICAgb25GaWxlTWVzc2FnZXNEaWRVcGRhdGU6IHN0b3JlLm9uRmlsZU1lc3NhZ2VzRGlkVXBkYXRlLmJpbmQoc3RvcmUpLFxuICAgICAgb25Qcm9qZWN0TWVzc2FnZXNEaWRVcGRhdGU6IHN0b3JlLm9uUHJvamVjdE1lc3NhZ2VzRGlkVXBkYXRlLmJpbmQoc3RvcmUpLFxuICAgICAgb25BbGxNZXNzYWdlc0RpZFVwZGF0ZTogc3RvcmUub25BbGxNZXNzYWdlc0RpZFVwZGF0ZS5iaW5kKHN0b3JlKSxcbiAgICAgIGFwcGx5Rml4OiBzdG9yZS5hcHBseUZpeC5iaW5kKHN0b3JlKSxcbiAgICAgIGFwcGx5Rml4ZXNGb3JGaWxlOiBzdG9yZS5hcHBseUZpeGVzRm9yRmlsZS5iaW5kKHN0b3JlKSxcbiAgICB9O1xuICB9XG4gIHJldHVybiBkaWFnbm9zdGljVXBkYXRlcjtcbn1cblxubGV0IGNvbnN1bWVMZWdhY3lMaW50ZXJzID0gZmFsc2U7XG5sZXQgbGludE9uVGhlRmx5ID0gZmFsc2U7XG5jb25zdCBhbGxMaW50ZXJBZGFwdGVycyA9IG5ldyBTZXQoKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGFjdGl2YXRlKHN0YXRlOiA/T2JqZWN0KTogdm9pZCB7XG4gICAgaWYgKCFkaXNwb3NhYmxlcykge1xuICAgICAgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgIH1cblxuICAgIC8vIFJldHVybnMgbWl4ZWQgc28gYSBjYXN0IGlzIG5lY2Vzc2FyeS5cbiAgICBjb25zdW1lTGVnYWN5TGludGVycyA9ICgoZmVhdHVyZUNvbmZpZy5nZXQobGVnYWN5TGludGVyU2V0dGluZyk6IGFueSk6IGJvb2xlYW4pO1xuICAgIGZlYXR1cmVDb25maWcub2JzZXJ2ZShsZWdhY3lMaW50ZXJTZXR0aW5nLCBuZXdWYWx1ZSA9PiB7XG4gICAgICAvLyBUbyBtYWtlIHRoaXMgcmVhbGx5IHNvbGlkLCB3ZSBzaG91bGQgYWxzbyBwcm9iYWJseSB0cmlnZ2VyIHRoZSBsaW50ZXJcbiAgICAgIC8vIGZvciB0aGUgYWN0aXZlIHRleHQgZWRpdG9yLiBQb3NzaWJseSBtb3JlIHRyb3VibGUgdGhhbiBpdCdzIHdvcnRoLFxuICAgICAgLy8gdGhvdWdoLCBzaW5jZSB0aGlzIG1heSBiZSBhIHRlbXBvcmFyeSBvcHRpb24uXG4gICAgICBjb25zdW1lTGVnYWN5TGludGVycyA9IG5ld1ZhbHVlO1xuICAgICAgYWxsTGludGVyQWRhcHRlcnMuZm9yRWFjaChhZGFwdGVyID0+IGFkYXB0ZXIuc2V0RW5hYmxlZChuZXdWYWx1ZSkpO1xuICAgIH0pO1xuXG4gICAgbGludE9uVGhlRmx5ID0gKChmZWF0dXJlQ29uZmlnLmdldChsZWdhY3lMaW50T25UaGVGbHlTZXR0aW5nKTogYW55KTogYm9vbGVhbik7XG4gICAgZmVhdHVyZUNvbmZpZy5vYnNlcnZlKGxlZ2FjeUxpbnRPblRoZUZseVNldHRpbmcsIG5ld1ZhbHVlID0+IHtcbiAgICAgIGxpbnRPblRoZUZseSA9IG5ld1ZhbHVlO1xuICAgICAgYWxsTGludGVyQWRhcHRlcnMuZm9yRWFjaChhZGFwdGVyID0+IGFkYXB0ZXIuc2V0TGludE9uRmx5KG5ld1ZhbHVlKSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgY29uc3VtZUxpbnRlclByb3ZpZGVyKHByb3ZpZGVyOiBMaW50ZXJQcm92aWRlciB8IEFycmF5PExpbnRlclByb3ZpZGVyPik6IElEaXNwb3NhYmxlIHtcbiAgICBjb25zdCB7Y3JlYXRlQWRhcHRlcnN9ID0gcmVxdWlyZSgnLi9MaW50ZXJBZGFwdGVyRmFjdG9yeScpO1xuICAgIGNvbnN0IG5ld0FkYXB0ZXJzID0gY3JlYXRlQWRhcHRlcnMocHJvdmlkZXIpO1xuICAgIGNvbnN0IGFkYXB0ZXJEaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgZm9yIChjb25zdCBhZGFwdGVyIG9mIG5ld0FkYXB0ZXJzKSB7XG4gICAgICBhZGFwdGVyLnNldEVuYWJsZWQoY29uc3VtZUxlZ2FjeUxpbnRlcnMpO1xuICAgICAgYWRhcHRlci5zZXRMaW50T25GbHkobGludE9uVGhlRmx5KTtcbiAgICAgIGFsbExpbnRlckFkYXB0ZXJzLmFkZChhZGFwdGVyKTtcbiAgICAgIGNvbnN0IGRpYWdub3N0aWNEaXNwb3NhYmxlID0gdGhpcy5jb25zdW1lRGlhZ25vc3RpY3NQcm92aWRlclYxKGFkYXB0ZXIpO1xuICAgICAgY29uc3QgYWRhcHRlckRpc3Bvc2FibGUgPSBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICAgIGRpYWdub3N0aWNEaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICAgICAgYWRhcHRlci5kaXNwb3NlKCk7XG4gICAgICAgIGFsbExpbnRlckFkYXB0ZXJzLmRlbGV0ZShhZGFwdGVyKTtcbiAgICAgIH0pO1xuICAgICAgYWRhcHRlckRpc3Bvc2FibGVzLmFkZChhZGFwdGVyRGlzcG9zYWJsZSk7XG4gICAgICBhZGREaXNwb3NhYmxlKGFkYXB0ZXIpO1xuICAgIH1cbiAgICByZXR1cm4gYWRhcHRlckRpc3Bvc2FibGVzO1xuICB9LFxuXG4gIGNvbnN1bWVEaWFnbm9zdGljc1Byb3ZpZGVyVjEocHJvdmlkZXI6IENhbGxiYWNrRGlhZ25vc3RpY1Byb3ZpZGVyKTogSURpc3Bvc2FibGUge1xuICAgIC8vIFJlZ2lzdGVyIHRoZSBkaWFnbm9zdGljIHN0b3JlIGZvciB1cGRhdGVzIGZyb20gdGhlIG5ldyBwcm92aWRlci5cbiAgICBjb25zdCBvYnNlcnZhYmxlUHJvdmlkZXIgPSB7XG4gICAgICB1cGRhdGVzOiBvYnNlcnZhYmxlRnJvbVN1YnNjcmliZUZ1bmN0aW9uKHByb3ZpZGVyLm9uTWVzc2FnZVVwZGF0ZS5iaW5kKHByb3ZpZGVyKSksXG4gICAgICBpbnZhbGlkYXRpb25zOiBvYnNlcnZhYmxlRnJvbVN1YnNjcmliZUZ1bmN0aW9uKHByb3ZpZGVyLm9uTWVzc2FnZUludmFsaWRhdGlvbi5iaW5kKHByb3ZpZGVyKSksXG4gICAgfTtcbiAgICBjb25zdCBkaXNwb3NhYmxlID0gdGhpcy5jb25zdW1lRGlhZ25vc3RpY3NQcm92aWRlclYyKG9ic2VydmFibGVQcm92aWRlcik7XG4gICAgYWRkRGlzcG9zYWJsZShkaXNwb3NhYmxlKTtcbiAgICByZXR1cm4gZGlzcG9zYWJsZTtcbiAgfSxcblxuICBjb25zdW1lRGlhZ25vc3RpY3NQcm92aWRlclYyKHByb3ZpZGVyOiBPYnNlcnZhYmxlRGlhZ25vc3RpY1Byb3ZpZGVyKTogSURpc3Bvc2FibGUge1xuICAgIGNvbnN0IGNvbXBvc2l0ZURpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgIGNvbnN0IHN0b3JlID0gZ2V0RGlhZ25vc3RpY1N0b3JlKCk7XG5cbiAgICBjb21wb3NpdGVEaXNwb3NhYmxlLmFkZChcbiAgICAgIHByb3ZpZGVyLnVwZGF0ZXMuc3Vic2NyaWJlKHVwZGF0ZSA9PiBzdG9yZS51cGRhdGVNZXNzYWdlcyhwcm92aWRlciwgdXBkYXRlKSlcbiAgICApO1xuICAgIGNvbXBvc2l0ZURpc3Bvc2FibGUuYWRkKFxuICAgICAgcHJvdmlkZXIuaW52YWxpZGF0aW9ucy5zdWJzY3JpYmUoXG4gICAgICAgIGludmFsaWRhdGlvbiA9PiBzdG9yZS5pbnZhbGlkYXRlTWVzc2FnZXMocHJvdmlkZXIsIGludmFsaWRhdGlvbilcbiAgICAgIClcbiAgICApO1xuICAgIGNvbXBvc2l0ZURpc3Bvc2FibGUuYWRkKG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHN0b3JlLmludmFsaWRhdGVNZXNzYWdlcyhwcm92aWRlciwgeyBzY29wZTogJ2FsbCcgfSk7XG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIGNvbXBvc2l0ZURpc3Bvc2FibGU7XG4gIH0sXG5cbiAgcHJvdmlkZURpYWdub3N0aWNVcGRhdGVzKCk6IERpYWdub3N0aWNVcGRhdGVyIHtcbiAgICByZXR1cm4gZ2V0RGlhZ25vc3RpY1VwZGF0ZXIoKTtcbiAgfSxcblxuICBkZWFjdGl2YXRlKCkge1xuICAgIGlmIChkaXNwb3NhYmxlcykge1xuICAgICAgZGlzcG9zYWJsZXMuZGlzcG9zZSgpO1xuICAgICAgZGlzcG9zYWJsZXMgPSBudWxsO1xuICAgIH1cbiAgICBpZiAoZGlhZ25vc3RpY1N0b3JlKSB7XG4gICAgICBkaWFnbm9zdGljU3RvcmUuZGlzcG9zZSgpO1xuICAgICAgZGlhZ25vc3RpY1N0b3JlID0gbnVsbDtcbiAgICB9XG4gICAgZGlhZ25vc3RpY1VwZGF0ZXIgPSBudWxsO1xuICB9LFxufTtcbiJdfQ==