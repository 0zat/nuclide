Object.defineProperty(exports, '__esModule', {
  value: true
});

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.createOutlines = createOutlines;

var outlineForEditor = _asyncToGenerator(function* (providers, editor) {
  var scopeName = editor.getGrammar().scopeName;
  var readableGrammarName = editor.getGrammar().name;

  var outlineProvider = providers.findProvider(scopeName);
  if (outlineProvider == null) {
    return {
      kind: 'no-provider',
      grammar: readableGrammarName
    };
  }
  var outline = undefined;
  try {
    outline = yield outlineProvider.getOutline(editor);
  } catch (e) {
    logger.error('Error in outline provider:', e);
    outline = null;
  }
  if (outline == null) {
    return {
      kind: 'provider-no-outline'
    };
  }
  return {
    kind: 'outline',
    outlineTrees: outline.outlineTrees.map(treeToUiTree),
    editor: editor
  };
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

var _reactivexRxjs = require('@reactivex/rxjs');

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _nuclideCommons = require('../../nuclide-commons');

var _nuclideAtomHelpers = require('../../nuclide-atom-helpers');

var _nuclideLogging = require('../../nuclide-logging');

var observableFromSubscribeFunction = _nuclideCommons.event.observableFromSubscribeFunction;

var logger = (0, _nuclideLogging.getLogger)();

var TAB_SWITCH_DELAY = 100; // ms

function createOutlines(providers) {
  var paneChanges = observableFromSubscribeFunction(atom.workspace.observeActivePaneItem.bind(atom.workspace))
  // Delay the work on tab switch to keep tab switches snappy and avoid doing a bunch of
  // computation if there are a lot of consecutive tab switches.
  .debounceTime(TAB_SWITCH_DELAY);

  return paneChanges.map(function () {
    return atom.workspace.getActiveTextEditor();
  }).switchMap(function (editor) {
    return outlinesForEditor(providers, editor);
  });
}

function outlinesForEditor(providers, editorArg) {
  // needs to be const so the refinement holds in closures
  var editor = editorArg;
  if (editor == null) {
    return _reactivexRxjs.Observable.of({
      kind: 'not-text-editor'
    });
  }

  var editorEvents = _reactivexRxjs.Observable.concat(
  // Emit one event at the beginning to trigger the computation of the initial outline
  _reactivexRxjs.Observable.of(null), observableFromSubscribeFunction(editor.onDidStopChanging.bind(editor)));

  var outlines = editorEvents.flatMap(function () {
    return outlineForEditor(providers, editor);
  });

  var highlightedOutlines = outlines.switchMap(function (outline) {
    if (outline.kind !== 'outline') {
      return _reactivexRxjs.Observable.of(outline);
    }
    return (0, _nuclideAtomHelpers.getCursorPositions)(editor).map(function (cursorLocation) {
      return highlightCurrentNode(outline, cursorLocation);
    });
  });

  return _reactivexRxjs.Observable.concat(_reactivexRxjs.Observable.of({ kind: 'empty' }), highlightedOutlines);
}

function treeToUiTree(outlineTree) {
  return {
    plainText: outlineTree.plainText,
    tokenizedText: outlineTree.tokenizedText,
    startPosition: outlineTree.startPosition,
    endPosition: outlineTree.endPosition,
    highlighted: false,
    children: outlineTree.children.map(treeToUiTree)
  };
}

// Return an outline object with the node under the cursor highlighted. Does not mutate the
// original.
function highlightCurrentNode(outline, cursorLocation) {
  (0, _assert2['default'])(outline.kind === 'outline');
  return _extends({}, outline, {
    outlineTrees: highlightCurrentNodeInTrees(outline.outlineTrees, cursorLocation)
  });
}

function highlightCurrentNodeInTrees(outlineTrees, cursorLocation) {
  return outlineTrees.map(function (tree) {
    return _extends({}, tree, {
      highlighted: shouldHighlightNode(tree, cursorLocation),
      children: highlightCurrentNodeInTrees(tree.children, cursorLocation)
    });
  });
}

function shouldHighlightNode(outlineTree, cursorLocation) {
  var startPosition = outlineTree.startPosition;
  var endPosition = outlineTree.endPosition;
  if (endPosition == null) {
    return false;
  }
  if (outlineTree.children.length !== 0) {
    var childStartPosition = outlineTree.children[0].startPosition;
    // Since the parent is rendered in the list above the children, it doesn't really make sense to
    // highlight it if you are below the start position of any child. However, if you are at the top
    // of a class it does seem desirable to highlight it.
    return cursorLocation.isGreaterThanOrEqual(startPosition) && cursorLocation.isLessThan(childStartPosition);
  }
  return cursorLocation.isGreaterThanOrEqual(startPosition) && cursorLocation.isLessThanOrEqual(endPosition);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNyZWF0ZU91dGxpbmVzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7SUEyRWUsZ0JBQWdCLHFCQUEvQixXQUNFLFNBQTJCLEVBQzNCLE1BQXVCLEVBQ0E7QUFDdkIsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQztBQUNoRCxNQUFNLG1CQUFtQixHQUFHLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUM7O0FBRXJELE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDMUQsTUFBSSxlQUFlLElBQUksSUFBSSxFQUFFO0FBQzNCLFdBQU87QUFDTCxVQUFJLEVBQUUsYUFBYTtBQUNuQixhQUFPLEVBQUUsbUJBQW1CO0tBQzdCLENBQUM7R0FDSDtBQUNELE1BQUksT0FBaUIsWUFBQSxDQUFDO0FBQ3RCLE1BQUk7QUFDRixXQUFPLEdBQUcsTUFBTSxlQUFlLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0dBQ3BELENBQUMsT0FBTyxDQUFDLEVBQUU7QUFDVixVQUFNLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzlDLFdBQU8sR0FBRyxJQUFJLENBQUM7R0FDaEI7QUFDRCxNQUFJLE9BQU8sSUFBSSxJQUFJLEVBQUU7QUFDbkIsV0FBTztBQUNMLFVBQUksRUFBRSxxQkFBcUI7S0FDNUIsQ0FBQztHQUNIO0FBQ0QsU0FBTztBQUNMLFFBQUksRUFBRSxTQUFTO0FBQ2YsZ0JBQVksRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUM7QUFDcEQsVUFBTSxFQUFOLE1BQU07R0FDUCxDQUFDO0NBQ0g7Ozs7Ozs2QkE1RndCLGlCQUFpQjs7c0JBQ3BCLFFBQVE7Ozs7OEJBRU0sdUJBQXVCOztrQ0FHMUIsNEJBQTRCOzs4QkFFckMsdUJBQXVCOztJQUp4QywrQkFBK0IseUJBQS9CLCtCQUErQjs7QUFLdEMsSUFBTSxNQUFNLEdBQUcsZ0NBQVcsQ0FBQzs7QUFFM0IsSUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUM7O0FBQ3RCLFNBQVMsY0FBYyxDQUFDLFNBQTJCLEVBQTRCO0FBQ3BGLE1BQU0sV0FBVyxHQUFHLCtCQUErQixDQUMvQyxJQUFJLENBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQzFEOzs7R0FHQSxZQUFZLENBQUMsZ0JBQWdCLENBQUMsQ0FBQzs7QUFFbEMsU0FBTyxXQUFXLENBQ2YsR0FBRyxDQUFDO1dBQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRTtHQUFBLENBQUMsQ0FDL0MsU0FBUyxDQUFDLFVBQUEsTUFBTTtXQUFJLGlCQUFpQixDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUM7R0FBQSxDQUFDLENBQUM7Q0FDOUQ7O0FBRUQsU0FBUyxpQkFBaUIsQ0FDeEIsU0FBMkIsRUFDM0IsU0FBMkIsRUFDRDs7QUFFMUIsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDO0FBQ3pCLE1BQUksTUFBTSxJQUFJLElBQUksRUFBRTtBQUNsQixXQUFPLDBCQUFXLEVBQUUsQ0FBQztBQUNuQixVQUFJLEVBQUUsaUJBQWlCO0tBQ3hCLENBQUMsQ0FBQztHQUNKOztBQUVELE1BQU0sWUFBWSxHQUFHLDBCQUFXLE1BQU07O0FBRXBDLDRCQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFDbkIsK0JBQStCLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUN2RSxDQUFDOztBQUVGLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUM7V0FBTSxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDO0dBQUEsQ0FBQyxDQUFDOztBQUVqRixNQUFNLG1CQUFtQixHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsVUFBQSxPQUFPLEVBQUk7QUFDeEQsUUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRTtBQUM5QixhQUFPLDBCQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUMvQjtBQUNELFdBQU8sNENBQW1CLE1BQU0sQ0FBQyxDQUM5QixHQUFHLENBQUMsVUFBQSxjQUFjLEVBQUk7QUFDckIsYUFBTyxvQkFBb0IsQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDLENBQUM7S0FDdEQsQ0FBQyxDQUFDO0dBQ04sQ0FBQyxDQUFDOztBQUVILFNBQU8sMEJBQVcsTUFBTSxDQUN0QiwwQkFBVyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFDaEMsbUJBQW1CLENBQ3BCLENBQUM7Q0FDSDs7QUFtQ0QsU0FBUyxZQUFZLENBQUMsV0FBd0IsRUFBb0I7QUFDaEUsU0FBTztBQUNMLGFBQVMsRUFBRSxXQUFXLENBQUMsU0FBUztBQUNoQyxpQkFBYSxFQUFFLFdBQVcsQ0FBQyxhQUFhO0FBQ3hDLGlCQUFhLEVBQUUsV0FBVyxDQUFDLGFBQWE7QUFDeEMsZUFBVyxFQUFFLFdBQVcsQ0FBQyxXQUFXO0FBQ3BDLGVBQVcsRUFBRSxLQUFLO0FBQ2xCLFlBQVEsRUFBRSxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUM7R0FDakQsQ0FBQztDQUNIOzs7O0FBSUQsU0FBUyxvQkFBb0IsQ0FBQyxPQUFxQixFQUFFLGNBQTBCLEVBQWdCO0FBQzdGLDJCQUFVLE9BQU8sQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUM7QUFDdEMsc0JBQ0ssT0FBTztBQUNWLGdCQUFZLEVBQUUsMkJBQTJCLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxjQUFjLENBQUM7S0FDL0U7Q0FDSDs7QUFFRCxTQUFTLDJCQUEyQixDQUNsQyxZQUFxQyxFQUNyQyxjQUEwQixFQUNEO0FBQ3pCLFNBQU8sWUFBWSxDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUksRUFBSTtBQUM5Qix3QkFDSyxJQUFJO0FBQ1AsaUJBQVcsRUFBRSxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDO0FBQ3RELGNBQVEsRUFBRSwyQkFBMkIsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLGNBQWMsQ0FBQztPQUNwRTtHQUNILENBQUMsQ0FBQztDQUNKOztBQUVELFNBQVMsbUJBQW1CLENBQUMsV0FBNkIsRUFBRSxjQUEwQixFQUFXO0FBQy9GLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxhQUFhLENBQUM7QUFDaEQsTUFBTSxXQUFXLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQztBQUM1QyxNQUFJLFdBQVcsSUFBSSxJQUFJLEVBQUU7QUFDdkIsV0FBTyxLQUFLLENBQUM7R0FDZDtBQUNELE1BQUksV0FBVyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO0FBQ3JDLFFBQU0sa0JBQWtCLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7Ozs7QUFJakUsV0FBTyxjQUFjLENBQUMsb0JBQW9CLENBQUMsYUFBYSxDQUFDLElBQ3ZELGNBQWMsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQztHQUNqRDtBQUNELFNBQU8sY0FBYyxDQUFDLG9CQUFvQixDQUFDLGFBQWEsQ0FBQyxJQUN4RCxjQUFjLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7Q0FDaEQiLCJmaWxlIjoiY3JlYXRlT3V0bGluZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7T3V0bGluZSwgT3V0bGluZUZvclVpLCBPdXRsaW5lVHJlZSwgT3V0bGluZVRyZWVGb3JVaX0gZnJvbSAnLi4nO1xuaW1wb3J0IHR5cGUge1Byb3ZpZGVyUmVnaXN0cnl9IGZyb20gJy4vUHJvdmlkZXJSZWdpc3RyeSc7XG5cbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAnQHJlYWN0aXZleC9yeGpzJztcbmltcG9ydCBpbnZhcmlhbnQgZnJvbSAnYXNzZXJ0JztcblxuaW1wb3J0IHtldmVudCBhcyBjb21tb25zRXZlbnR9IGZyb20gJy4uLy4uL251Y2xpZGUtY29tbW9ucyc7XG5jb25zdCB7b2JzZXJ2YWJsZUZyb21TdWJzY3JpYmVGdW5jdGlvbn0gPSBjb21tb25zRXZlbnQ7XG5cbmltcG9ydCB7Z2V0Q3Vyc29yUG9zaXRpb25zfSBmcm9tICcuLi8uLi9udWNsaWRlLWF0b20taGVscGVycyc7XG5cbmltcG9ydCB7Z2V0TG9nZ2VyfSBmcm9tICcuLi8uLi9udWNsaWRlLWxvZ2dpbmcnO1xuY29uc3QgbG9nZ2VyID0gZ2V0TG9nZ2VyKCk7XG5cbmNvbnN0IFRBQl9TV0lUQ0hfREVMQVkgPSAxMDA7IC8vIG1zXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlT3V0bGluZXMocHJvdmlkZXJzOiBQcm92aWRlclJlZ2lzdHJ5KTogT2JzZXJ2YWJsZTxPdXRsaW5lRm9yVWk+IHtcbiAgY29uc3QgcGFuZUNoYW5nZXMgPSBvYnNlcnZhYmxlRnJvbVN1YnNjcmliZUZ1bmN0aW9uKFxuICAgICAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtLmJpbmQoYXRvbS53b3Jrc3BhY2UpLFxuICAgIClcbiAgICAvLyBEZWxheSB0aGUgd29yayBvbiB0YWIgc3dpdGNoIHRvIGtlZXAgdGFiIHN3aXRjaGVzIHNuYXBweSBhbmQgYXZvaWQgZG9pbmcgYSBidW5jaCBvZlxuICAgIC8vIGNvbXB1dGF0aW9uIGlmIHRoZXJlIGFyZSBhIGxvdCBvZiBjb25zZWN1dGl2ZSB0YWIgc3dpdGNoZXMuXG4gICAgLmRlYm91bmNlVGltZShUQUJfU1dJVENIX0RFTEFZKTtcblxuICByZXR1cm4gcGFuZUNoYW5nZXNcbiAgICAubWFwKCgpID0+IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKSlcbiAgICAuc3dpdGNoTWFwKGVkaXRvciA9PiBvdXRsaW5lc0ZvckVkaXRvcihwcm92aWRlcnMsIGVkaXRvcikpO1xufVxuXG5mdW5jdGlvbiBvdXRsaW5lc0ZvckVkaXRvcihcbiAgcHJvdmlkZXJzOiBQcm92aWRlclJlZ2lzdHJ5LFxuICBlZGl0b3JBcmc6ID9hdG9tJFRleHRFZGl0b3IsXG4pOiBPYnNlcnZhYmxlPE91dGxpbmVGb3JVaT4ge1xuICAvLyBuZWVkcyB0byBiZSBjb25zdCBzbyB0aGUgcmVmaW5lbWVudCBob2xkcyBpbiBjbG9zdXJlc1xuICBjb25zdCBlZGl0b3IgPSBlZGl0b3JBcmc7XG4gIGlmIChlZGl0b3IgPT0gbnVsbCkge1xuICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKHtcbiAgICAgIGtpbmQ6ICdub3QtdGV4dC1lZGl0b3InLFxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgZWRpdG9yRXZlbnRzID0gT2JzZXJ2YWJsZS5jb25jYXQoXG4gICAgLy8gRW1pdCBvbmUgZXZlbnQgYXQgdGhlIGJlZ2lubmluZyB0byB0cmlnZ2VyIHRoZSBjb21wdXRhdGlvbiBvZiB0aGUgaW5pdGlhbCBvdXRsaW5lXG4gICAgT2JzZXJ2YWJsZS5vZihudWxsKSxcbiAgICBvYnNlcnZhYmxlRnJvbVN1YnNjcmliZUZ1bmN0aW9uKGVkaXRvci5vbkRpZFN0b3BDaGFuZ2luZy5iaW5kKGVkaXRvcikpLFxuICApO1xuXG4gIGNvbnN0IG91dGxpbmVzID0gZWRpdG9yRXZlbnRzLmZsYXRNYXAoKCkgPT4gb3V0bGluZUZvckVkaXRvcihwcm92aWRlcnMsIGVkaXRvcikpO1xuXG4gIGNvbnN0IGhpZ2hsaWdodGVkT3V0bGluZXMgPSBvdXRsaW5lcy5zd2l0Y2hNYXAob3V0bGluZSA9PiB7XG4gICAgaWYgKG91dGxpbmUua2luZCAhPT0gJ291dGxpbmUnKSB7XG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZihvdXRsaW5lKTtcbiAgICB9XG4gICAgcmV0dXJuIGdldEN1cnNvclBvc2l0aW9ucyhlZGl0b3IpXG4gICAgICAubWFwKGN1cnNvckxvY2F0aW9uID0+IHtcbiAgICAgICAgcmV0dXJuIGhpZ2hsaWdodEN1cnJlbnROb2RlKG91dGxpbmUsIGN1cnNvckxvY2F0aW9uKTtcbiAgICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gT2JzZXJ2YWJsZS5jb25jYXQoXG4gICAgT2JzZXJ2YWJsZS5vZih7IGtpbmQ6ICdlbXB0eScgfSksXG4gICAgaGlnaGxpZ2h0ZWRPdXRsaW5lcyxcbiAgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gb3V0bGluZUZvckVkaXRvcihcbiAgcHJvdmlkZXJzOiBQcm92aWRlclJlZ2lzdHJ5LFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvclxuKTogUHJvbWlzZTxPdXRsaW5lRm9yVWk+IHtcbiAgY29uc3Qgc2NvcGVOYW1lID0gZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWU7XG4gIGNvbnN0IHJlYWRhYmxlR3JhbW1hck5hbWUgPSBlZGl0b3IuZ2V0R3JhbW1hcigpLm5hbWU7XG5cbiAgY29uc3Qgb3V0bGluZVByb3ZpZGVyID0gcHJvdmlkZXJzLmZpbmRQcm92aWRlcihzY29wZU5hbWUpO1xuICBpZiAob3V0bGluZVByb3ZpZGVyID09IG51bGwpIHtcbiAgICByZXR1cm4ge1xuICAgICAga2luZDogJ25vLXByb3ZpZGVyJyxcbiAgICAgIGdyYW1tYXI6IHJlYWRhYmxlR3JhbW1hck5hbWUsXG4gICAgfTtcbiAgfVxuICBsZXQgb3V0bGluZTogP091dGxpbmU7XG4gIHRyeSB7XG4gICAgb3V0bGluZSA9IGF3YWl0IG91dGxpbmVQcm92aWRlci5nZXRPdXRsaW5lKGVkaXRvcik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIG91dGxpbmUgcHJvdmlkZXI6JywgZSk7XG4gICAgb3V0bGluZSA9IG51bGw7XG4gIH1cbiAgaWYgKG91dGxpbmUgPT0gbnVsbCkge1xuICAgIHJldHVybiB7XG4gICAgICBraW5kOiAncHJvdmlkZXItbm8tb3V0bGluZScsXG4gICAgfTtcbiAgfVxuICByZXR1cm4ge1xuICAgIGtpbmQ6ICdvdXRsaW5lJyxcbiAgICBvdXRsaW5lVHJlZXM6IG91dGxpbmUub3V0bGluZVRyZWVzLm1hcCh0cmVlVG9VaVRyZWUpLFxuICAgIGVkaXRvcixcbiAgfTtcbn1cblxuZnVuY3Rpb24gdHJlZVRvVWlUcmVlKG91dGxpbmVUcmVlOiBPdXRsaW5lVHJlZSk6IE91dGxpbmVUcmVlRm9yVWkge1xuICByZXR1cm4ge1xuICAgIHBsYWluVGV4dDogb3V0bGluZVRyZWUucGxhaW5UZXh0LFxuICAgIHRva2VuaXplZFRleHQ6IG91dGxpbmVUcmVlLnRva2VuaXplZFRleHQsXG4gICAgc3RhcnRQb3NpdGlvbjogb3V0bGluZVRyZWUuc3RhcnRQb3NpdGlvbixcbiAgICBlbmRQb3NpdGlvbjogb3V0bGluZVRyZWUuZW5kUG9zaXRpb24sXG4gICAgaGlnaGxpZ2h0ZWQ6IGZhbHNlLFxuICAgIGNoaWxkcmVuOiBvdXRsaW5lVHJlZS5jaGlsZHJlbi5tYXAodHJlZVRvVWlUcmVlKSxcbiAgfTtcbn1cblxuLy8gUmV0dXJuIGFuIG91dGxpbmUgb2JqZWN0IHdpdGggdGhlIG5vZGUgdW5kZXIgdGhlIGN1cnNvciBoaWdobGlnaHRlZC4gRG9lcyBub3QgbXV0YXRlIHRoZVxuLy8gb3JpZ2luYWwuXG5mdW5jdGlvbiBoaWdobGlnaHRDdXJyZW50Tm9kZShvdXRsaW5lOiBPdXRsaW5lRm9yVWksIGN1cnNvckxvY2F0aW9uOiBhdG9tJFBvaW50KTogT3V0bGluZUZvclVpIHtcbiAgaW52YXJpYW50KG91dGxpbmUua2luZCA9PT0gJ291dGxpbmUnKTtcbiAgcmV0dXJuIHtcbiAgICAuLi5vdXRsaW5lLFxuICAgIG91dGxpbmVUcmVlczogaGlnaGxpZ2h0Q3VycmVudE5vZGVJblRyZWVzKG91dGxpbmUub3V0bGluZVRyZWVzLCBjdXJzb3JMb2NhdGlvbiksXG4gIH07XG59XG5cbmZ1bmN0aW9uIGhpZ2hsaWdodEN1cnJlbnROb2RlSW5UcmVlcyhcbiAgb3V0bGluZVRyZWVzOiBBcnJheTxPdXRsaW5lVHJlZUZvclVpPixcbiAgY3Vyc29yTG9jYXRpb246IGF0b20kUG9pbnRcbik6IEFycmF5PE91dGxpbmVUcmVlRm9yVWk+IHtcbiAgcmV0dXJuIG91dGxpbmVUcmVlcy5tYXAodHJlZSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnRyZWUsXG4gICAgICBoaWdobGlnaHRlZDogc2hvdWxkSGlnaGxpZ2h0Tm9kZSh0cmVlLCBjdXJzb3JMb2NhdGlvbiksXG4gICAgICBjaGlsZHJlbjogaGlnaGxpZ2h0Q3VycmVudE5vZGVJblRyZWVzKHRyZWUuY2hpbGRyZW4sIGN1cnNvckxvY2F0aW9uKSxcbiAgICB9O1xuICB9KTtcbn1cblxuZnVuY3Rpb24gc2hvdWxkSGlnaGxpZ2h0Tm9kZShvdXRsaW5lVHJlZTogT3V0bGluZVRyZWVGb3JVaSwgY3Vyc29yTG9jYXRpb246IGF0b20kUG9pbnQpOiBib29sZWFuIHtcbiAgY29uc3Qgc3RhcnRQb3NpdGlvbiA9IG91dGxpbmVUcmVlLnN0YXJ0UG9zaXRpb247XG4gIGNvbnN0IGVuZFBvc2l0aW9uID0gb3V0bGluZVRyZWUuZW5kUG9zaXRpb247XG4gIGlmIChlbmRQb3NpdGlvbiA9PSBudWxsKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGlmIChvdXRsaW5lVHJlZS5jaGlsZHJlbi5sZW5ndGggIT09IDApIHtcbiAgICBjb25zdCBjaGlsZFN0YXJ0UG9zaXRpb24gPSBvdXRsaW5lVHJlZS5jaGlsZHJlblswXS5zdGFydFBvc2l0aW9uO1xuICAgIC8vIFNpbmNlIHRoZSBwYXJlbnQgaXMgcmVuZGVyZWQgaW4gdGhlIGxpc3QgYWJvdmUgdGhlIGNoaWxkcmVuLCBpdCBkb2Vzbid0IHJlYWxseSBtYWtlIHNlbnNlIHRvXG4gICAgLy8gaGlnaGxpZ2h0IGl0IGlmIHlvdSBhcmUgYmVsb3cgdGhlIHN0YXJ0IHBvc2l0aW9uIG9mIGFueSBjaGlsZC4gSG93ZXZlciwgaWYgeW91IGFyZSBhdCB0aGUgdG9wXG4gICAgLy8gb2YgYSBjbGFzcyBpdCBkb2VzIHNlZW0gZGVzaXJhYmxlIHRvIGhpZ2hsaWdodCBpdC5cbiAgICByZXR1cm4gY3Vyc29yTG9jYXRpb24uaXNHcmVhdGVyVGhhbk9yRXF1YWwoc3RhcnRQb3NpdGlvbikgJiZcbiAgICAgIGN1cnNvckxvY2F0aW9uLmlzTGVzc1RoYW4oY2hpbGRTdGFydFBvc2l0aW9uKTtcbiAgfVxuICByZXR1cm4gY3Vyc29yTG9jYXRpb24uaXNHcmVhdGVyVGhhbk9yRXF1YWwoc3RhcnRQb3NpdGlvbikgJiZcbiAgIGN1cnNvckxvY2F0aW9uLmlzTGVzc1RoYW5PckVxdWFsKGVuZFBvc2l0aW9uKTtcbn1cbiJdfQ==