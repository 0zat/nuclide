Object.defineProperty(exports, '__esModule', {
  value: true
});

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var UPDATE_EVENT = 'update';
var INVALIDATE_EVENT = 'invalidate';

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;
var Emitter = _require.Emitter;

function getTextEventDispatcher() {
  return require('../../nuclide-text-event-dispatcher').getInstance();
}

var DiagnosticsProviderBase = (function () {
  function DiagnosticsProviderBase(options) {
    var textEventDispatcher = arguments.length <= 1 || arguments[1] === undefined ? getTextEventDispatcher() : arguments[1];

    _classCallCheck(this, DiagnosticsProviderBase);

    this._textEventDispatcher = textEventDispatcher;
    this._emitter = new Emitter();
    this._disposables = new CompositeDisposable();

    this._textEventCallback = callbackOrNoop(options.onTextEditorEvent);
    this._newUpdateSubscriberCallback = callbackOrNoop(options.onNewUpdateSubscriber);
    this._newInvalidateSubscriberCallback = callbackOrNoop(options.onNewInvalidateSubscriber);

    // The Set constructor creates an empty Set if passed null or undefined.
    this._grammarScopes = new Set(options.grammarScopes);
    this._allGrammarScopes = !!options.enableForAllGrammars;
    this._subscribeToTextEditorEvent(!!options.shouldRunOnTheFly);
  }

  /**
   * Subscribes to the appropriate event depending on whether we should run on
   * the fly or not.
   */

  _createClass(DiagnosticsProviderBase, [{
    key: '_subscribeToTextEditorEvent',
    value: function _subscribeToTextEditorEvent(shouldRunOnTheFly) {
      this._disposeEventSubscription();
      var dispatcher = this._textEventDispatcher;
      var subscription = undefined;
      if (shouldRunOnTheFly) {
        if (this._allGrammarScopes) {
          subscription = dispatcher.onAnyFileChange(this._textEventCallback);
        } else {
          subscription = dispatcher.onFileChange(this._grammarScopes, this._textEventCallback);
        }
      } else {
        if (this._allGrammarScopes) {
          subscription = dispatcher.onAnyFileSave(this._textEventCallback);
        } else {
          subscription = dispatcher.onFileSave(this._grammarScopes, this._textEventCallback);
        }
      }
      this._currentEventSubscription = subscription;
    }
  }, {
    key: 'setRunOnTheFly',
    value: function setRunOnTheFly(runOnTheFly) {
      this._subscribeToTextEditorEvent(runOnTheFly);
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      this._emitter.dispose();
      this._disposables.dispose();
      this._disposeEventSubscription();
    }
  }, {
    key: '_disposeEventSubscription',
    value: function _disposeEventSubscription() {
      if (this._currentEventSubscription) {
        this._currentEventSubscription.dispose();
        this._currentEventSubscription = null;
      }
    }

    /**
     * Clients can call these methods to publish messages
     */

  }, {
    key: 'publishMessageUpdate',
    value: function publishMessageUpdate(update) {
      this._emitter.emit(UPDATE_EVENT, update);
    }
  }, {
    key: 'publishMessageInvalidation',
    value: function publishMessageInvalidation(message) {
      this._emitter.emit(INVALIDATE_EVENT, message);
    }

    /**
     * Clients should delegate to these
     */

  }, {
    key: 'onMessageUpdate',
    value: function onMessageUpdate(callback) {
      var disposable = this._emitter.on(UPDATE_EVENT, callback);
      this._newUpdateSubscriberCallback(callback);
      return disposable;
    }
  }, {
    key: 'onMessageInvalidation',
    value: function onMessageInvalidation(callback) {
      var disposable = this._emitter.on(INVALIDATE_EVENT, callback);
      this._newInvalidateSubscriberCallback(callback);
      return disposable;
    }
  }]);

  return DiagnosticsProviderBase;
})();

exports.DiagnosticsProviderBase = DiagnosticsProviderBase;

function callbackOrNoop(callback) {
  return callback ? callback.bind(undefined) : function () {};
}

/** The callback by which a provider is notified of text events, such as a file save. */

/**
 * The callback by which a provider is notified that a new consumer has subscribed to diagnostic
 * updates.
 */

/**
 * The callback by which a provider is notified that a new consumer has subscribed to diagnostic
 * invalidations.
 */

/**
 * If true, this will cause onTextEditorEvent to get called more often -- approximately whenever
 * the user stops typing. If false, it will get called only when the user saves.
 */

/**
 * The following two options specify which grammars the provider is interested in. Most providers
 * will include a set of grammarScopes, and will therefore get notifications only about
 * TextEditors that are associated with those grammarScopes. Instead, a provider may set
 * enableForAllGrammars to true, and then it will get notified of changes in all TextEditors. If
 * enableForAllGrammars is true, it overrides the grammars in grammarScopes.
 */

// callbacks provided by client
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRpYWdub3N0aWNzUHJvdmlkZXJCYXNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFnREEsSUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDO0FBQzlCLElBQU0sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDOztlQUVDLE9BQU8sQ0FBQyxNQUFNLENBQUM7O0lBQS9DLG1CQUFtQixZQUFuQixtQkFBbUI7SUFBRSxPQUFPLFlBQVAsT0FBTzs7QUFFbkMsU0FBUyxzQkFBc0IsR0FBRztBQUNoQyxTQUFPLE9BQU8sQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0NBQ3JFOztJQUVZLHVCQUF1QjtBQWlCdkIsV0FqQkEsdUJBQXVCLENBa0JoQyxPQUE0QixFQUU1QjtRQURBLG1CQUF5Qyx5REFBRyxzQkFBc0IsRUFBRTs7MEJBbkIzRCx1QkFBdUI7O0FBcUJoQyxRQUFJLENBQUMsb0JBQW9CLEdBQUcsbUJBQW1CLENBQUM7QUFDaEQsUUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0FBQzlCLFFBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDOztBQUU5QyxRQUFJLENBQUMsa0JBQWtCLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3BFLFFBQUksQ0FBQyw0QkFBNEIsR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDbEYsUUFBSSxDQUFDLGdDQUFnQyxHQUFHLGNBQWMsQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQzs7O0FBRzFGLFFBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3JELFFBQUksQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDO0FBQ3hELFFBQUksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7R0FDL0Q7Ozs7Ozs7ZUFqQ1UsdUJBQXVCOztXQXVDUCxxQ0FBQyxpQkFBMEIsRUFBRTtBQUN0RCxVQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQztBQUNqQyxVQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUM7QUFDN0MsVUFBSSxZQUFZLFlBQUEsQ0FBQztBQUNqQixVQUFJLGlCQUFpQixFQUFFO0FBQ3JCLFlBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFO0FBQzFCLHNCQUFZLEdBQUcsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUNwRSxNQUFNO0FBQ0wsc0JBQVksR0FBRyxVQUFVLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDdEY7T0FDRixNQUFNO0FBQ0wsWUFBSSxJQUFJLENBQUMsaUJBQWlCLEVBQUU7QUFDMUIsc0JBQVksR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ2xFLE1BQU07QUFDTCxzQkFBWSxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUNwRjtPQUNGO0FBQ0QsVUFBSSxDQUFDLHlCQUF5QixHQUFHLFlBQVksQ0FBQztLQUMvQzs7O1dBRWEsd0JBQUMsV0FBb0IsRUFBRTtBQUNuQyxVQUFJLENBQUMsMkJBQTJCLENBQUMsV0FBVyxDQUFDLENBQUM7S0FDL0M7OztXQUVNLG1CQUFTO0FBQ2QsVUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN4QixVQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzVCLFVBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO0tBQ2xDOzs7V0FFd0IscUNBQVM7QUFDaEMsVUFBSSxJQUFJLENBQUMseUJBQXlCLEVBQUU7QUFDbEMsWUFBSSxDQUFDLHlCQUF5QixDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3pDLFlBQUksQ0FBQyx5QkFBeUIsR0FBRyxJQUFJLENBQUM7T0FDdkM7S0FDRjs7Ozs7Ozs7V0FNbUIsOEJBQUMsTUFBZ0MsRUFBUTtBQUMzRCxVQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDMUM7OztXQUV5QixvQ0FBQyxPQUE0QixFQUFRO0FBQzdELFVBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQy9DOzs7Ozs7OztXQU1jLHlCQUFDLFFBQStCLEVBQWU7QUFDNUQsVUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQzVELFVBQUksQ0FBQyw0QkFBNEIsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM1QyxhQUFPLFVBQVUsQ0FBQztLQUNuQjs7O1dBRW9CLCtCQUFDLFFBQXFDLEVBQWU7QUFDeEUsVUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDaEUsVUFBSSxDQUFDLGdDQUFnQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2hELGFBQU8sVUFBVSxDQUFDO0tBQ25COzs7U0F0R1UsdUJBQXVCOzs7OztBQXlHcEMsU0FBUyxjQUFjLENBQUksUUFBNEIsRUFBcUI7QUFDMUUsU0FBTyxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxZQUFNLEVBQUcsQ0FBQztDQUN4RCIsImZpbGUiOiJEaWFnbm9zdGljc1Byb3ZpZGVyQmFzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmltcG9ydCB0eXBlIHtcbiAgRGlhZ25vc3RpY1Byb3ZpZGVyVXBkYXRlLFxuICBJbnZhbGlkYXRpb25NZXNzYWdlLFxuICBNZXNzYWdlSW52YWxpZGF0aW9uQ2FsbGJhY2ssXG4gIE1lc3NhZ2VVcGRhdGVDYWxsYmFjayxcbn0gZnJvbSAnLi4vLi4vbnVjbGlkZS1kaWFnbm9zdGljcy1iYXNlJztcbmltcG9ydCB0eXBlIHtUZXh0RXZlbnREaXNwYXRjaGVyfSBmcm9tICcuLi8uLi9udWNsaWRlLXRleHQtZXZlbnQtZGlzcGF0Y2hlcic7XG5cbnR5cGUgUHJvdmlkZXJCYXNlT3B0aW9ucyA9IHtcbiAgLyoqIFRoZSBjYWxsYmFjayBieSB3aGljaCBhIHByb3ZpZGVyIGlzIG5vdGlmaWVkIG9mIHRleHQgZXZlbnRzLCBzdWNoIGFzIGEgZmlsZSBzYXZlLiAqL1xuICBvblRleHRFZGl0b3JFdmVudD86IChlZGl0b3I6IFRleHRFZGl0b3IpID0+IG1peGVkO1xuICAvKipcbiAgICogVGhlIGNhbGxiYWNrIGJ5IHdoaWNoIGEgcHJvdmlkZXIgaXMgbm90aWZpZWQgdGhhdCBhIG5ldyBjb25zdW1lciBoYXMgc3Vic2NyaWJlZCB0byBkaWFnbm9zdGljXG4gICAqIHVwZGF0ZXMuXG4gICAqL1xuICBvbk5ld1VwZGF0ZVN1YnNjcmliZXI/OiAoY2FsbGJhY2s6IE1lc3NhZ2VVcGRhdGVDYWxsYmFjaykgPT4gbWl4ZWQ7XG4gIC8qKlxuICAgKiBUaGUgY2FsbGJhY2sgYnkgd2hpY2ggYSBwcm92aWRlciBpcyBub3RpZmllZCB0aGF0IGEgbmV3IGNvbnN1bWVyIGhhcyBzdWJzY3JpYmVkIHRvIGRpYWdub3N0aWNcbiAgICogaW52YWxpZGF0aW9ucy5cbiAgICovXG4gIG9uTmV3SW52YWxpZGF0ZVN1YnNjcmliZXI/OiAoY2FsbGJhY2s6IE1lc3NhZ2VJbnZhbGlkYXRpb25DYWxsYmFjaykgPT4gbWl4ZWQ7XG4gIC8qKlxuICAgKiBJZiB0cnVlLCB0aGlzIHdpbGwgY2F1c2Ugb25UZXh0RWRpdG9yRXZlbnQgdG8gZ2V0IGNhbGxlZCBtb3JlIG9mdGVuIC0tIGFwcHJveGltYXRlbHkgd2hlbmV2ZXJcbiAgICogdGhlIHVzZXIgc3RvcHMgdHlwaW5nLiBJZiBmYWxzZSwgaXQgd2lsbCBnZXQgY2FsbGVkIG9ubHkgd2hlbiB0aGUgdXNlciBzYXZlcy5cbiAgICovXG4gIHNob3VsZFJ1bk9uVGhlRmx5PzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFRoZSBmb2xsb3dpbmcgdHdvIG9wdGlvbnMgc3BlY2lmeSB3aGljaCBncmFtbWFycyB0aGUgcHJvdmlkZXIgaXMgaW50ZXJlc3RlZCBpbi4gTW9zdCBwcm92aWRlcnNcbiAgICogd2lsbCBpbmNsdWRlIGEgc2V0IG9mIGdyYW1tYXJTY29wZXMsIGFuZCB3aWxsIHRoZXJlZm9yZSBnZXQgbm90aWZpY2F0aW9ucyBvbmx5IGFib3V0XG4gICAqIFRleHRFZGl0b3JzIHRoYXQgYXJlIGFzc29jaWF0ZWQgd2l0aCB0aG9zZSBncmFtbWFyU2NvcGVzLiBJbnN0ZWFkLCBhIHByb3ZpZGVyIG1heSBzZXRcbiAgICogZW5hYmxlRm9yQWxsR3JhbW1hcnMgdG8gdHJ1ZSwgYW5kIHRoZW4gaXQgd2lsbCBnZXQgbm90aWZpZWQgb2YgY2hhbmdlcyBpbiBhbGwgVGV4dEVkaXRvcnMuIElmXG4gICAqIGVuYWJsZUZvckFsbEdyYW1tYXJzIGlzIHRydWUsIGl0IG92ZXJyaWRlcyB0aGUgZ3JhbW1hcnMgaW4gZ3JhbW1hclNjb3Blcy5cbiAgICovXG4gIGdyYW1tYXJTY29wZXM/OiBTZXQ8c3RyaW5nPjtcbiAgZW5hYmxlRm9yQWxsR3JhbW1hcnM/OiBib29sZWFuO1xufTtcblxuY29uc3QgVVBEQVRFX0VWRU5UID0gJ3VwZGF0ZSc7XG5jb25zdCBJTlZBTElEQVRFX0VWRU5UID0gJ2ludmFsaWRhdGUnO1xuXG5jb25zdCB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgRW1pdHRlcn0gPSByZXF1aXJlKCdhdG9tJyk7XG5cbmZ1bmN0aW9uIGdldFRleHRFdmVudERpc3BhdGNoZXIoKSB7XG4gIHJldHVybiByZXF1aXJlKCcuLi8uLi9udWNsaWRlLXRleHQtZXZlbnQtZGlzcGF0Y2hlcicpLmdldEluc3RhbmNlKCk7XG59XG5cbmV4cG9ydCBjbGFzcyBEaWFnbm9zdGljc1Byb3ZpZGVyQmFzZSB7XG4gIF90ZXh0RXZlbnREaXNwYXRjaGVyOiBUZXh0RXZlbnREaXNwYXRjaGVyO1xuXG4gIF9lbWl0dGVyOiBFbWl0dGVyO1xuXG4gIF9ncmFtbWFyU2NvcGVzOiBTZXQ8c3RyaW5nPjtcbiAgX2FsbEdyYW1tYXJTY29wZXM6ID9ib29sZWFuO1xuXG4gIF9jdXJyZW50RXZlbnRTdWJzY3JpcHRpb246ID9JRGlzcG9zYWJsZTtcblxuICBfZGlzcG9zYWJsZXM6IGF0b20kQ29tcG9zaXRlRGlzcG9zYWJsZTtcblxuICAvLyBjYWxsYmFja3MgcHJvdmlkZWQgYnkgY2xpZW50XG4gIF90ZXh0RXZlbnRDYWxsYmFjazogKGVkaXRvcjogVGV4dEVkaXRvcikgPT4gbWl4ZWQ7XG4gIF9uZXdVcGRhdGVTdWJzY3JpYmVyQ2FsbGJhY2s6IChjYWxsYmFjazogTWVzc2FnZVVwZGF0ZUNhbGxiYWNrKSA9PiBtaXhlZDtcbiAgX25ld0ludmFsaWRhdGVTdWJzY3JpYmVyQ2FsbGJhY2s6IChjYWxsYmFjazogTWVzc2FnZUludmFsaWRhdGlvbkNhbGxiYWNrKSA9PiBtaXhlZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBvcHRpb25zOiBQcm92aWRlckJhc2VPcHRpb25zLFxuICAgIHRleHRFdmVudERpc3BhdGNoZXI/OiBUZXh0RXZlbnREaXNwYXRjaGVyID0gZ2V0VGV4dEV2ZW50RGlzcGF0Y2hlcigpLFxuICApIHtcbiAgICB0aGlzLl90ZXh0RXZlbnREaXNwYXRjaGVyID0gdGV4dEV2ZW50RGlzcGF0Y2hlcjtcbiAgICB0aGlzLl9lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKTtcbiAgICB0aGlzLl9kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5cbiAgICB0aGlzLl90ZXh0RXZlbnRDYWxsYmFjayA9IGNhbGxiYWNrT3JOb29wKG9wdGlvbnMub25UZXh0RWRpdG9yRXZlbnQpO1xuICAgIHRoaXMuX25ld1VwZGF0ZVN1YnNjcmliZXJDYWxsYmFjayA9IGNhbGxiYWNrT3JOb29wKG9wdGlvbnMub25OZXdVcGRhdGVTdWJzY3JpYmVyKTtcbiAgICB0aGlzLl9uZXdJbnZhbGlkYXRlU3Vic2NyaWJlckNhbGxiYWNrID0gY2FsbGJhY2tPck5vb3Aob3B0aW9ucy5vbk5ld0ludmFsaWRhdGVTdWJzY3JpYmVyKTtcblxuICAgIC8vIFRoZSBTZXQgY29uc3RydWN0b3IgY3JlYXRlcyBhbiBlbXB0eSBTZXQgaWYgcGFzc2VkIG51bGwgb3IgdW5kZWZpbmVkLlxuICAgIHRoaXMuX2dyYW1tYXJTY29wZXMgPSBuZXcgU2V0KG9wdGlvbnMuZ3JhbW1hclNjb3Blcyk7XG4gICAgdGhpcy5fYWxsR3JhbW1hclNjb3BlcyA9ICEhb3B0aW9ucy5lbmFibGVGb3JBbGxHcmFtbWFycztcbiAgICB0aGlzLl9zdWJzY3JpYmVUb1RleHRFZGl0b3JFdmVudCghIW9wdGlvbnMuc2hvdWxkUnVuT25UaGVGbHkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZXMgdG8gdGhlIGFwcHJvcHJpYXRlIGV2ZW50IGRlcGVuZGluZyBvbiB3aGV0aGVyIHdlIHNob3VsZCBydW4gb25cbiAgICogdGhlIGZseSBvciBub3QuXG4gICAqL1xuICBfc3Vic2NyaWJlVG9UZXh0RWRpdG9yRXZlbnQoc2hvdWxkUnVuT25UaGVGbHk6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9kaXNwb3NlRXZlbnRTdWJzY3JpcHRpb24oKTtcbiAgICBjb25zdCBkaXNwYXRjaGVyID0gdGhpcy5fdGV4dEV2ZW50RGlzcGF0Y2hlcjtcbiAgICBsZXQgc3Vic2NyaXB0aW9uO1xuICAgIGlmIChzaG91bGRSdW5PblRoZUZseSkge1xuICAgICAgaWYgKHRoaXMuX2FsbEdyYW1tYXJTY29wZXMpIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uID0gZGlzcGF0Y2hlci5vbkFueUZpbGVDaGFuZ2UodGhpcy5fdGV4dEV2ZW50Q2FsbGJhY2spO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uID0gZGlzcGF0Y2hlci5vbkZpbGVDaGFuZ2UodGhpcy5fZ3JhbW1hclNjb3BlcywgdGhpcy5fdGV4dEV2ZW50Q2FsbGJhY2spO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5fYWxsR3JhbW1hclNjb3Blcykge1xuICAgICAgICBzdWJzY3JpcHRpb24gPSBkaXNwYXRjaGVyLm9uQW55RmlsZVNhdmUodGhpcy5fdGV4dEV2ZW50Q2FsbGJhY2spO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uID0gZGlzcGF0Y2hlci5vbkZpbGVTYXZlKHRoaXMuX2dyYW1tYXJTY29wZXMsIHRoaXMuX3RleHRFdmVudENhbGxiYWNrKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fY3VycmVudEV2ZW50U3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uO1xuICB9XG5cbiAgc2V0UnVuT25UaGVGbHkocnVuT25UaGVGbHk6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9zdWJzY3JpYmVUb1RleHRFZGl0b3JFdmVudChydW5PblRoZUZseSk7XG4gIH1cblxuICBkaXNwb3NlKCk6IHZvaWQge1xuICAgIHRoaXMuX2VtaXR0ZXIuZGlzcG9zZSgpO1xuICAgIHRoaXMuX2Rpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcbiAgICB0aGlzLl9kaXNwb3NlRXZlbnRTdWJzY3JpcHRpb24oKTtcbiAgfVxuXG4gIF9kaXNwb3NlRXZlbnRTdWJzY3JpcHRpb24oKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX2N1cnJlbnRFdmVudFN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5fY3VycmVudEV2ZW50U3Vic2NyaXB0aW9uLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuX2N1cnJlbnRFdmVudFN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsaWVudHMgY2FuIGNhbGwgdGhlc2UgbWV0aG9kcyB0byBwdWJsaXNoIG1lc3NhZ2VzXG4gICAqL1xuXG4gIHB1Ymxpc2hNZXNzYWdlVXBkYXRlKHVwZGF0ZTogRGlhZ25vc3RpY1Byb3ZpZGVyVXBkYXRlKTogdm9pZCB7XG4gICAgdGhpcy5fZW1pdHRlci5lbWl0KFVQREFURV9FVkVOVCwgdXBkYXRlKTtcbiAgfVxuXG4gIHB1Ymxpc2hNZXNzYWdlSW52YWxpZGF0aW9uKG1lc3NhZ2U6IEludmFsaWRhdGlvbk1lc3NhZ2UpOiB2b2lkIHtcbiAgICB0aGlzLl9lbWl0dGVyLmVtaXQoSU5WQUxJREFURV9FVkVOVCwgbWVzc2FnZSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xpZW50cyBzaG91bGQgZGVsZWdhdGUgdG8gdGhlc2VcbiAgICovXG5cbiAgb25NZXNzYWdlVXBkYXRlKGNhbGxiYWNrOiBNZXNzYWdlVXBkYXRlQ2FsbGJhY2spOiBJRGlzcG9zYWJsZSB7XG4gICAgY29uc3QgZGlzcG9zYWJsZSA9IHRoaXMuX2VtaXR0ZXIub24oVVBEQVRFX0VWRU5ULCBjYWxsYmFjayk7XG4gICAgdGhpcy5fbmV3VXBkYXRlU3Vic2NyaWJlckNhbGxiYWNrKGNhbGxiYWNrKTtcbiAgICByZXR1cm4gZGlzcG9zYWJsZTtcbiAgfVxuXG4gIG9uTWVzc2FnZUludmFsaWRhdGlvbihjYWxsYmFjazogTWVzc2FnZUludmFsaWRhdGlvbkNhbGxiYWNrKTogSURpc3Bvc2FibGUge1xuICAgIGNvbnN0IGRpc3Bvc2FibGUgPSB0aGlzLl9lbWl0dGVyLm9uKElOVkFMSURBVEVfRVZFTlQsIGNhbGxiYWNrKTtcbiAgICB0aGlzLl9uZXdJbnZhbGlkYXRlU3Vic2NyaWJlckNhbGxiYWNrKGNhbGxiYWNrKTtcbiAgICByZXR1cm4gZGlzcG9zYWJsZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxsYmFja09yTm9vcDxUPihjYWxsYmFjazogPyhhcmc6IFQpID0+IG1peGVkKTogKGFyZzogVCkgPT4gbWl4ZWQge1xuICByZXR1cm4gY2FsbGJhY2sgPyBjYWxsYmFjay5iaW5kKHVuZGVmaW5lZCkgOiAoKSA9PiB7IH07XG59XG4iXX0=