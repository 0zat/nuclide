
/* @noflow */

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

/*eslint-disable no-console*/

var Module = require('module');
var profileRequireTime = require('./profile-require-time');

exports.init = function () {
  var options = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  // Load expensive libs so we don't skew the results.
  if (options.preloadExpensive) {
    require('@reactivex/rxjs');
    require('react-for-atom').React;
    require('react-for-atom').ReactDOM;
  }

  var byRoot = Boolean(options.byRoot);
  var byLoadOrder = Boolean(options.byLoadOrder);
  var loadOrderMinDuration = parseInt(options.loadOrderMinDuration, 10) || 0;

  profileRequireTime.start();

  var onNuclideActivate = atom.packages.onDidActivatePackage(function (pack) {
    if (pack.name === 'nuclide') {
      onNuclideActivate.dispose();
      console.log('Nuclide ready time: %sms', pack.activateTime + pack.loadTime);
      var profile = profileRequireTime.stop();
      if (byLoadOrder) {
        printByLoadOrder(profile, loadOrderMinDuration);
      }
      if (byRoot) {
        printByRoot(profile);
      }
    }
  });
};

function printByLoadOrder(_ref, minDuration) {
  var data = _ref.data;
  var startTime = _ref.startTime;
  var stopTime = _ref.stopTime;

  console.groupCollapsed('Nuclide requires by load order');
  var table = [['order', 'ms', 'depth:filename']];
  data.filter(function (entry) {
    return entry.duration >= minDuration;
  }).forEach(function (entry) {
    var shortName = entry.filename.replace(entry.basedir, '');
    table.push([entry.order, entry.duration + 'ms', entry.depth + ':' + leftTruncate(shortName, 70)]);
  });
  console.log(toTable(table), '(' + data.length + ' modules required during ' + (stopTime - startTime) + 'ms)');
  console.groupEnd();
}

function printByRoot(_ref2) {
  var data = _ref2.data;
  var startTime = _ref2.startTime;
  var stopTime = _ref2.stopTime;

  var dataByFilename = {};
  data.forEach(function (entry) {
    dataByFilename[entry.filename] = entry;
  });

  console.groupCollapsed('Nuclide requires by root');
  data.filter(function (entry) {
    var _module = Module._cache[entry.filename];
    var parentFilename = _module.parent.filename;
    return !parentFilename.startsWith(entry.basedir) || parentFilename === module.parent.filename;
  }).forEach(function (rootEntry) {
    console.group(rootEntry.filename.replace(rootEntry.basedir, ''));
    var table = [['order', 'ms', 'depth:filename']];
    (function traverse(filename) {
      var _entry = dataByFilename[filename];
      var shortName = _entry.filename.replace(_entry.basedir, '');
      table.push([_entry.order, _entry.duration + 'ms', _entry.depth + ':' + leftTruncate(shortName, 70)]);
      Module._cache[filename].children.forEach(function (child) {
        if (child.filename.startsWith(rootEntry.basedir)) {
          traverse(child.filename);
        }
      });
    })(rootEntry.filename);
    console.log(toTable(table));
    console.groupEnd();
  });
  console.groupEnd();
}

function leftTruncate(str, maxLength) {
  return str.length <= maxLength ? str : 'â€¦' + str.substr(-maxLength);
}

function toTable(rows) {
  var maxWidths = [];
  rows.forEach(function (row) {
    row.forEach(function (item, i) {
      maxWidths[i] = Math.max(maxWidths[i] || 0, String(item).length);
    });
  });

  var lines = '';
  rows.forEach(function (row) {
    row.forEach(function (item, i) {
      var padlen = Math.max(maxWidths[i] - String(item).length + 2, 0);
      lines += String(item) + ' '.repeat(padlen);
    });
    lines += '\n';
  });

  return lines;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyYWNrLW51Y2xpZGUtcmVhZHkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQWFBLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxJQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDOztBQUU3RCxPQUFPLENBQUMsSUFBSSxHQUFHLFlBQXVCO01BQWQsT0FBTyx5REFBRyxFQUFFOzs7QUFFbEMsTUFBSSxPQUFPLENBQUMsZ0JBQWdCLEVBQUU7QUFDNUIsV0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDM0IsV0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ2hDLFdBQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQztHQUNwQzs7QUFFRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3ZDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDakQsTUFBTSxvQkFBb0IsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFN0Usb0JBQWtCLENBQUMsS0FBSyxFQUFFLENBQUM7O0FBRTNCLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFBLElBQUksRUFBSTtBQUNuRSxRQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFO0FBQzNCLHVCQUFpQixDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzVCLGFBQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUcsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDNUUsVUFBTSxPQUFPLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7QUFD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RSxDQUFDLEVBQUs7QUFDdkIsZUFBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDakUsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDOztBQUVILE1BQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztBQUNmLE1BQUksQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHLEVBQUk7QUFDbEIsT0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQUksRUFBRSxDQUFDLEVBQUs7QUFDdkIsVUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDbkUsV0FBSyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQzVDLENBQUMsQ0FBQztBQUNILFNBQUssSUFBSSxJQUFJLENBQUM7R0FDZixDQUFDLENBQUM7O0FBRUgsU0FBTyxLQUFLLENBQUM7Q0FDZCIsImZpbGUiOiJ0cmFjay1udWNsaWRlLXJlYWR5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAbm9mbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG4vKmVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUqL1xuXG5jb25zdCBNb2R1bGUgPSByZXF1aXJlKCdtb2R1bGUnKTtcbmNvbnN0IHByb2ZpbGVSZXF1aXJlVGltZSA9IHJlcXVpcmUoJy4vcHJvZmlsZS1yZXF1aXJlLXRpbWUnKTtcblxuZXhwb3J0cy5pbml0ID0gZnVuY3Rpb24ob3B0aW9ucyA9IHt9KSB7XG4gIC8vIExvYWQgZXhwZW5zaXZlIGxpYnMgc28gd2UgZG9uJ3Qgc2tldyB0aGUgcmVzdWx0cy5cbiAgaWYgKG9wdGlvbnMucHJlbG9hZEV4cGVuc2l2ZSkge1xuICAgIHJlcXVpcmUoJ0ByZWFjdGl2ZXgvcnhqcycpO1xuICAgIHJlcXVpcmUoJ3JlYWN0LWZvci1hdG9tJykuUmVhY3Q7XG4gICAgcmVxdWlyZSgncmVhY3QtZm9yLWF0b20nKS5SZWFjdERPTTtcbiAgfVxuXG4gIGNvbnN0IGJ5Um9vdCA9IEJvb2xlYW4ob3B0aW9ucy5ieVJvb3QpO1xuICBjb25zdCBieUxvYWRPcmRlciA9IEJvb2xlYW4ob3B0aW9ucy5ieUxvYWRPcmRlcik7XG4gIGNvbnN0IGxvYWRPcmRlck1pbkR1cmF0aW9uID0gcGFyc2VJbnQob3B0aW9ucy5sb2FkT3JkZXJNaW5EdXJhdGlvbiwgMTApIHx8IDA7XG5cbiAgcHJvZmlsZVJlcXVpcmVUaW1lLnN0YXJ0KCk7XG5cbiAgY29uc3Qgb25OdWNsaWRlQWN0aXZhdGUgPSBhdG9tLnBhY2thZ2VzLm9uRGlkQWN0aXZhdGVQYWNrYWdlKHBhY2sgPT4ge1xuICAgIGlmIChwYWNrLm5hbWUgPT09ICdudWNsaWRlJykge1xuICAgICAgb25OdWNsaWRlQWN0aXZhdGUuZGlzcG9zZSgpO1xuICAgICAgY29uc29sZS5sb2coJ051Y2xpZGUgcmVhZHkgdGltZTogJXNtcycsICBwYWNrLmFjdGl2YXRlVGltZSArIHBhY2subG9hZFRpbWUpO1xuICAgICAgY29uc3QgcHJvZmlsZSA9IHByb2ZpbGVSZXF1aXJlVGltZS5zdG9wKCk7XG4gICAgICBpZiAoYnlMb2FkT3JkZXIpIHtcbiAgICAgICAgcHJpbnRCeUxvYWRPcmRlcihwcm9maWxlLCBsb2FkT3JkZXJNaW5EdXJhdGlvbik7XG4gICAgICB9XG4gICAgICBpZiAoYnlSb290KSB7XG4gICAgICAgIHByaW50QnlSb290KHByb2ZpbGUpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59O1xuXG5mdW5jdGlvbiBwcmludEJ5TG9hZE9yZGVyKHtkYXRhLCBzdGFydFRpbWUsIHN0b3BUaW1lfSwgbWluRHVyYXRpb24pIHtcbiAgY29uc29sZS5ncm91cENvbGxhcHNlZCgnTnVjbGlkZSByZXF1aXJlcyBieSBsb2FkIG9yZGVyJyk7XG4gIGNvbnN0IHRhYmxlID0gW1snb3JkZXInLCAnbXMnLCAnZGVwdGg6ZmlsZW5hbWUnXV07XG4gIGRhdGFcbiAgICAuZmlsdGVyKGVudHJ5ID0+IGVudHJ5LmR1cmF0aW9uID49IG1pbkR1cmF0aW9uKVxuICAgIC5mb3JFYWNoKGVudHJ5ID0+IHtcbiAgICAgIGNvbnN0IHNob3J0TmFtZSA9IGVudHJ5LmZpbGVuYW1lLnJlcGxhY2UoZW50cnkuYmFzZWRpciwgJycpO1xuICAgICAgdGFibGUucHVzaChbXG4gICAgICAgIGVudHJ5Lm9yZGVyLFxuICAgICAgICBlbnRyeS5kdXJhdGlvbiArICdtcycsXG4gICAgICAgIGVudHJ5LmRlcHRoICsgJzonICsgbGVmdFRydW5jYXRlKHNob3J0TmFtZSwgNzApLFxuICAgICAgXSk7XG4gICAgfSk7XG4gIGNvbnNvbGUubG9nKFxuICAgIHRvVGFibGUodGFibGUpLFxuICAgIGAoJHtkYXRhLmxlbmd0aH0gbW9kdWxlcyByZXF1aXJlZCBkdXJpbmcgJHtzdG9wVGltZSAtIHN0YXJ0VGltZX1tcylgXG4gICk7XG4gIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbn1cblxuZnVuY3Rpb24gcHJpbnRCeVJvb3Qoe2RhdGEsIHN0YXJ0VGltZSwgc3RvcFRpbWV9KSB7XG4gIGNvbnN0IGRhdGFCeUZpbGVuYW1lID0ge307XG4gIGRhdGEuZm9yRWFjaChlbnRyeSA9PiB7IGRhdGFCeUZpbGVuYW1lW2VudHJ5LmZpbGVuYW1lXSA9IGVudHJ5OyB9KTtcblxuICBjb25zb2xlLmdyb3VwQ29sbGFwc2VkKCdOdWNsaWRlIHJlcXVpcmVzIGJ5IHJvb3QnKTtcbiAgZGF0YVxuICAgIC5maWx0ZXIoZW50cnkgPT4ge1xuICAgICAgY29uc3QgX21vZHVsZSA9IE1vZHVsZS5fY2FjaGVbZW50cnkuZmlsZW5hbWVdO1xuICAgICAgY29uc3QgcGFyZW50RmlsZW5hbWUgPSBfbW9kdWxlLnBhcmVudC5maWxlbmFtZTtcbiAgICAgIHJldHVybiAhcGFyZW50RmlsZW5hbWUuc3RhcnRzV2l0aChlbnRyeS5iYXNlZGlyKSB8fFxuICAgICAgICAgICAgIHBhcmVudEZpbGVuYW1lID09PSBtb2R1bGUucGFyZW50LmZpbGVuYW1lO1xuICAgIH0pXG4gICAgLmZvckVhY2gocm9vdEVudHJ5ID0+IHtcbiAgICAgIGNvbnNvbGUuZ3JvdXAocm9vdEVudHJ5LmZpbGVuYW1lLnJlcGxhY2Uocm9vdEVudHJ5LmJhc2VkaXIsICcnKSk7XG4gICAgICBjb25zdCB0YWJsZSA9IFtbJ29yZGVyJywgJ21zJywgJ2RlcHRoOmZpbGVuYW1lJ11dO1xuICAgICAgKGZ1bmN0aW9uIHRyYXZlcnNlKGZpbGVuYW1lKSB7XG4gICAgICAgIGNvbnN0IF9lbnRyeSA9IGRhdGFCeUZpbGVuYW1lW2ZpbGVuYW1lXTtcbiAgICAgICAgY29uc3Qgc2hvcnROYW1lID0gX2VudHJ5LmZpbGVuYW1lLnJlcGxhY2UoX2VudHJ5LmJhc2VkaXIsICcnKTtcbiAgICAgICAgdGFibGUucHVzaChbXG4gICAgICAgICAgX2VudHJ5Lm9yZGVyLFxuICAgICAgICAgIF9lbnRyeS5kdXJhdGlvbiArICdtcycsXG4gICAgICAgICAgX2VudHJ5LmRlcHRoICsgJzonICsgbGVmdFRydW5jYXRlKHNob3J0TmFtZSwgNzApLFxuICAgICAgICBdKTtcbiAgICAgICAgTW9kdWxlLl9jYWNoZVtmaWxlbmFtZV0uY2hpbGRyZW4uZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgICAgICAgaWYgKGNoaWxkLmZpbGVuYW1lLnN0YXJ0c1dpdGgocm9vdEVudHJ5LmJhc2VkaXIpKSB7XG4gICAgICAgICAgICB0cmF2ZXJzZShjaGlsZC5maWxlbmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pKHJvb3RFbnRyeS5maWxlbmFtZSk7XG4gICAgICBjb25zb2xlLmxvZyh0b1RhYmxlKHRhYmxlKSk7XG4gICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgfSk7XG4gIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbn1cblxuZnVuY3Rpb24gbGVmdFRydW5jYXRlKHN0ciwgbWF4TGVuZ3RoKSB7XG4gIHJldHVybiBzdHIubGVuZ3RoIDw9IG1heExlbmd0aCA/IHN0ciA6ICfigKYnICsgc3RyLnN1YnN0cigtbWF4TGVuZ3RoKTtcbn1cblxuZnVuY3Rpb24gdG9UYWJsZShyb3dzKSB7XG4gIGNvbnN0IG1heFdpZHRocyA9IFtdO1xuICByb3dzLmZvckVhY2gocm93ID0+IHtcbiAgICByb3cuZm9yRWFjaCgoaXRlbSwgaSkgPT4ge1xuICAgICAgbWF4V2lkdGhzW2ldID0gTWF0aC5tYXgobWF4V2lkdGhzW2ldIHx8IDAsIFN0cmluZyhpdGVtKS5sZW5ndGgpO1xuICAgIH0pO1xuICB9KTtcblxuICBsZXQgbGluZXMgPSAnJztcbiAgcm93cy5mb3JFYWNoKHJvdyA9PiB7XG4gICAgcm93LmZvckVhY2goKGl0ZW0sIGkpID0+IHtcbiAgICAgIGNvbnN0IHBhZGxlbiA9IE1hdGgubWF4KG1heFdpZHRoc1tpXSAtIFN0cmluZyhpdGVtKS5sZW5ndGggKyAyLCAwKTtcbiAgICAgIGxpbmVzICs9IFN0cmluZyhpdGVtKSArICcgJy5yZXBlYXQocGFkbGVuKTtcbiAgICB9KTtcbiAgICBsaW5lcyArPSAnXFxuJztcbiAgfSk7XG5cbiAgcmV0dXJuIGxpbmVzO1xufVxuIl19